<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaBot Pro - Instagram Automation SaaS</title>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        /* All your CSS styles remain the same - they are correct */
        /* ... (keeping all your existing CSS) ... */
    </style>
</head>
<body>
    <!-- üîÑ Loading Screen -->
    <div class="loading-screen" id="loadingScreen">
        <div class="loader"></div>
        <div class="loading-text">Loading InstaBot Pro...</div>
    </div>

    <!-- ============================================
     üè† LANDING PAGE
     ============================================ -->
    <div class="landing-page" id="landingPage">
        <!-- Navigation -->
        <nav class="navbar" aria-label="Main navigation">
            <div class="logo">
                <i class="fab fa-instagram" aria-hidden="true"></i>
                <span class="logo-text">InstaBot Pro</span>
            </div>
            
            <ul class="nav-links">
                <li><a href="#features" class="nav-link">Features</a></li>
                <li><a href="#pricing" class="nav-link">Pricing</a></li>
                <li><a href="#faq" class="nav-link">FAQ</a></li>
                <li><a href="#contact" class="nav-link">Contact</a></li>
            </ul>
            
            <div class="nav-buttons">
                <!-- FIXED: Changed onclick to call showAuthModal() instead of loginWithGoogle() -->
                <button class="btn btn-secondary" onclick="showAuthModal()" aria-label="Login to account">
                    <i class="fas fa-sign-in-alt" aria-hidden="true"></i> 
                    <span class="btn-text">Login</span>
                </button>
                <button class="btn btn-primary" onclick="showAuthModal()" aria-label="Get started for free">
                    <span class="btn-text">Get Started Free</span>
                </button>
            </div>
        </nav>

        <!-- Hero Section -->
        <section class="hero" aria-labelledby="hero-title">
            <div class="hero-content">
                <h1 id="hero-title" class="hero-title">
                    <span class="hero-emoji" aria-label="rocket">üöÄ</span>
                    Grow Your Instagram on Autopilot
                </h1>
                <p class="hero-description">
                    Automate your Instagram growth with AI-powered engagement. Get more followers, likes, and engagement without spending hours on your phone.
                </p>
                
                <div class="hero-actions">
                    <!-- FIXED: Added onclick handler -->
                    <button class="btn btn-lg btn-google" onclick="signInWithGoogle()">
                        <i class="fab fa-google" aria-hidden="true"></i> 
                        <span>Continue with Google</span>
                    </button>
                    <button class="btn btn-lg btn-outline" onclick="scrollToSection('pricing')">
                        <span>View Pricing</span>
                    </button>
                </div>
                
                <div class="hero-stats" role="region" aria-label="Statistics">
                    <div class="stat-item">
                        <div class="stat-number" aria-label="50 thousand plus">50K+</div>
                        <div class="stat-label">Active Users</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" aria-label="10 million plus">10M+</div>
                        <div class="stat-label">Actions Performed</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-number" aria-label="99.9 percent">99.9%</div>
                        <div class="stat-label">Uptime</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Features Section -->
        <section id="features" class="features-section" aria-labelledby="features-title">
            <div class="section-title">
                <h2 id="features-title">
                    <span class="section-icon" aria-label="lightning">‚ö°</span>
                    Powerful Features
                </h2>
                <p class="section-subtitle">Everything you need to grow your Instagram presence</p>
            </div>
            
            <div class="features-grid">
                <article class="feature-card">
                    <div class="feature-icon feature-icon-1" aria-hidden="true">
                        <i class="fas fa-users"></i>
                    </div>
                    <h3 class="feature-title">Auto Follow/Unfollow</h3>
                    <p class="feature-description">Automatically follow targeted users and unfollow non-followers to grow your audience.</p>
                </article>
                
                <article class="feature-card">
                    <div class="feature-icon feature-icon-2" aria-hidden="true">
                        <i class="fas fa-heart"></i>
                    </div>
                    <h3 class="feature-title">Smart Liking</h3>
                    <p class="feature-description">Like posts from your target audience to increase visibility and engagement.</p>
                </article>
                
                <article class="feature-card">
                    <div class="feature-icon feature-icon-3" aria-hidden="true">
                        <i class="fas fa-comment"></i>
                    </div>
                    <h3 class="feature-title">Auto Comments</h3>
                    <p class="feature-description">Leave meaningful comments using AI to engage with your community.</p>
                </article>
                
                <article class="feature-card">
                    <div class="feature-icon feature-icon-4" aria-hidden="true">
                        <i class="fas fa-paper-plane"></i>
                    </div>
                    <h3 class="feature-title">Auto DM</h3>
                    <p class="feature-description">Send personalized welcome messages to new followers automatically.</p>
                </article>
                
                <article class="feature-card">
                    <div class="feature-icon feature-icon-5" aria-hidden="true">
                        <i class="fas fa-chart-line"></i>
                    </div>
                    <h3 class="feature-title">Analytics Dashboard</h3>
                    <p class="feature-description">Track your growth with detailed analytics and insights.</p>
                </article>
                
                <article class="feature-card">
                    <div class="feature-icon feature-icon-6" aria-hidden="true">
                        <i class="fas fa-shield-alt"></i>
                    </div>
                    <h3 class="feature-title">Safe & Secure</h3>
                    <p class="feature-description">Human-like behavior patterns to keep your account safe.</p>
                </article>
            </div>
        </section>

        <!-- Pricing Section -->
        <section id="pricing" class="pricing-section" aria-labelledby="pricing-title">
            <div class="section-title">
                <h2 id="pricing-title">
                    <span class="section-icon" aria-label="gem">üíé</span>
                    Choose Your Plan
                </h2>
                <p class="section-subtitle">Start free and upgrade as you grow</p>
            </div>
            
            <div class="pricing-grid" id="pricingGrid" role="region" aria-label="Pricing plans">
                <!-- Plans will be loaded dynamically -->
                <div class="pricing-loading">
                    <i class="fas fa-spinner fa-spin" aria-hidden="true"></i>
                    <span class="sr-only">Loading pricing plans...</span>
                </div>
            </div>
        </section>

        <!-- FAQ Section -->
        <section id="faq" class="faq-section" aria-labelledby="faq-title">
            <div class="section-title">
                <h2 id="faq-title">
                    <span class="section-icon" aria-label="question mark">‚ùì</span>
                    Frequently Asked Questions
                </h2>
                <p class="section-subtitle">Got questions? We've got answers</p>
            </div>
            
            <div class="faq-container">
                <details class="faq-item">
                    <summary class="faq-question">
                        <span>Is InstaBot Pro safe to use?</span>
                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    </summary>
                    <div class="faq-answer">
                        <p>Yes! We use human-like behavior patterns and respect Instagram's rate limits. Our bot mimics natural user behavior to keep your account safe.</p>
                    </div>
                </details>
                
                <details class="faq-item">
                    <summary class="faq-question">
                        <span>How does payment verification work?</span>
                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    </summary>
                    <div class="faq-answer">
                        <p>After making a UPI payment, our admin team manually verifies your payment within 24 hours. You'll receive an email once your subscription is activated.</p>
                    </div>
                </details>
                
                <details class="faq-item">
                    <summary class="faq-question">
                        <span>Can I cancel my subscription anytime?</span>
                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    </summary>
                    <div class="faq-answer">
                        <p>Yes, you can cancel your subscription at any time. Your access will continue until the end of your billing period.</p>
                    </div>
                </details>
                
                <details class="faq-item">
                    <summary class="faq-question">
                        <span>How many Instagram accounts can I connect?</span>
                        <i class="fas fa-chevron-down" aria-hidden="true"></i>
                    </summary>
                    <div class="faq-answer">
                        <p>Free plan: 1 account, Pro plan: 5 accounts, Master plan: Unlimited accounts.</p>
                    </div>
                </details>
            </div>
        </section>

        <!-- Footer -->
        <footer class="main-footer" aria-label="Footer">
            <div class="footer-content">
                <div class="footer-section">
                    <div class="footer-logo">
                        <i class="fab fa-instagram" aria-hidden="true"></i>
                        <span class="footer-logo-text">InstaBot Pro</span>
                    </div>
                    <p class="footer-description">Automate your Instagram growth with the most powerful and safest bot on the market.</p>
                </div>
                
                <div class="footer-section">
                    <h4 class="footer-heading">Quick Links</h4>
                    <ul class="footer-links">
                        <li><a href="#features" class="footer-link">Features</a></li>
                        <li><a href="#pricing" class="footer-link">Pricing</a></li>
                        <li><a href="#faq" class="footer-link">FAQ</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4 class="footer-heading">Legal</h4>
                    <ul class="footer-links">
                        <li><a href="#privacy-policy" class="footer-link">Privacy Policy</a></li>
                        <li><a href="#terms" class="footer-link">Terms of Service</a></li>
                        <li><a href="#refund" class="footer-link">Refund Policy</a></li>
                    </ul>
                </div>
                
                <div class="footer-section">
                    <h4 class="footer-heading">Contact</h4>
                    <address class="footer-contact">
                        <p class="contact-item">
                            <i class="fas fa-envelope" aria-hidden="true"></i>
                            <a href="mailto:support@instabotpro.com" class="contact-link">support@instabotpro.com</a>
                        </p>
                        <p class="contact-item">
                            <i class="fab fa-telegram" aria-hidden="true"></i>
                            <a href="https://t.me/instabotpro" class="contact-link">@instabotpro</a>
                        </p>
                    </address>
                </div>
            </div>
            
            <div class="footer-bottom">
                <p class="copyright">&copy; <span id="current-year">2024</span> InstaBot Pro. All rights reserved.</p>
            </div>
        </footer>
    </div>

    <!-- ============================================
     üîê AUTH MODAL
     ============================================ -->
    <div class="auth-modal" id="authModal" aria-hidden="true" aria-labelledby="auth-modal-title">
        <div class="auth-box">
            <!-- FIXED: Added onclick handler -->
            <button class="modal-close" onclick="closeAuthModal()" aria-label="Close authentication modal">
                <i class="fas fa-times" aria-hidden="true"></i>
            </button>
            
            <div class="auth-header">
                <i class="fab fa-instagram auth-logo" aria-hidden="true"></i>
                <h2 id="auth-modal-title" class="auth-title">Welcome to InstaBot Pro</h2>
                <p class="auth-subtitle">Sign in to access your dashboard</p>
            </div>
            
            <div class="auth-body">
                <!-- FIXED: Added onclick handler -->
                <button class="btn btn-google btn-lg auth-button" onclick="signInWithGoogle()">
                    <img src="https://www.google.com/favicon.ico" alt="" class="google-icon">
                    <span>Continue with Google</span>
                </button>
                
                <div class="auth-divider" aria-hidden="true">
                    <span>or</span>
                </div>
                
                <p class="auth-terms">
                    By signing in, you agree to our 
                    <a href="#terms" class="terms-link">Terms of Service</a> and 
                    <a href="#privacy" class="terms-link">Privacy Policy</a>.
                </p>
            </div>
        </div>
    </div>

    <!-- ============================================
     üí≥ PAYMENT MODAL
     ============================================ -->
    <div class="payment-modal" id="paymentModal" aria-hidden="true" aria-labelledby="payment-modal-title">
        <div class="payment-box">
            <div class="payment-header">
                <h2 id="payment-modal-title" class="payment-title">
                    <span class="payment-icon" aria-hidden="true">üí≥</span>
                    Complete Payment
                </h2>
                <p id="paymentPlanName" class="payment-plan">Pro Plan - ‚Çπ199/month</p>
            </div>
            
            <div class="payment-body">
                <div class="qr-container">
                    <div class="qr-code" id="qrCode" role="img" aria-label="QR code for payment">
                        <!-- QR Code will be generated here -->
                        <div class="qr-placeholder">
                            <i class="fas fa-qrcode" aria-hidden="true"></i>
                            <span class="sr-only">QR Code Placeholder</span>
                        </div>
                    </div>
                    
                    <p class="qr-instruction">Scan QR code or pay to UPI ID below</p>
                    
                    <div class="upi-id">
                        <span id="upiIdDisplay" class="upi-text">Loading UPI ID...</span>
                        <!-- FIXED: Added onclick handler -->
                        <button class="copy-btn" onclick="copyUpiId()" aria-label="Copy UPI ID to clipboard">
                            <i class="fas fa-copy" aria-hidden="true"></i> 
                            <span class="copy-text">Copy</span>
                        </button>
                    </div>
                </div>

                <form class="payment-form" id="paymentForm" onsubmit="submitPayment(event)">
                    <div class="form-group">
                        <label for="transactionId" class="form-label">Transaction ID / UTR Number *</label>
                        <input type="text" id="transactionId" class="form-input" 
                               placeholder="Enter 12-digit UTR number" required>
                    </div>

                    <div class="form-group">
                        <label for="amountPaid" class="form-label">Amount Paid (‚Çπ) *</label>
                        <input type="number" id="amountPaid" class="form-input" 
                               placeholder="Enter amount paid" required>
                    </div>

                    <div class="alert alert-info" role="alert">
                        <i class="fas fa-info-circle" aria-hidden="true"></i>
                        <span>Payment will be verified manually within 24 hours. You'll receive an email once verified.</span>
                    </div>

                    <div class="payment-steps">
                        <div class="payment-step">
                            <div class="step-number" aria-hidden="true">1</div>
                            <div class="step-text">Open any UPI app (GPay, PhonePe, Paytm, etc.)</div>
                        </div>
                        <div class="payment-step">
                            <div class="step-number" aria-hidden="true">2</div>
                            <div class="step-text">Scan QR code or pay to the UPI ID shown above</div>
                        </div>
                        <div class="payment-step">
                            <div class="step-number" aria-hidden="true">3</div>
                            <div class="step-text">Enter the transaction ID after successful payment</div>
                        </div>
                        <div class="payment-step">
                            <div class="step-number" aria-hidden="true">4</div>
                            <div class="step-text">Wait for admin verification (usually within 24 hours)</div>
                        </div>
                    </div>

                    <div class="payment-actions">
                        <!-- FIXED: Added onclick handler -->
                        <button type="button" class="btn btn-secondary payment-cancel" onclick="closePaymentModal()">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary payment-submit" id="submitPaymentBtn">
                            <i class="fas fa-check" aria-hidden="true"></i>
                            <span>Submit Payment</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ============================================
     üìä USER DASHBOARD
     ============================================ -->
    <div class="dashboard-container" id="userDashboard">
        <!-- Dashboard HTML remains the same -->
        <!-- ... (keeping your dashboard HTML) ... -->
    </div>

    <!-- ============================================
     üõ°Ô∏è ADMIN DASHBOARD
     ============================================ -->
    <div class="dashboard-container" id="adminDashboard">
        <!-- Admin dashboard HTML remains the same -->
        <!-- ... (keeping your admin dashboard HTML) ... -->
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="toast-notification" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-content">
            <i id="toastIcon" class="fas fa-check-circle toast-icon" aria-hidden="true"></i>
            <span id="toastMessage" class="toast-message">Success!</span>
        </div>
    </div>

    <!-- ============================================
         üìú JAVASCRIPT - CORE CONFIGURATION
         ============================================ -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ============================================
        // üîë API CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://uvnksakgjupnivmfkjcv.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2bmtzYWtnanVwbml2bWZramN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NzM5NzYsImV4cCI6MjA4MTQ0OTk3Nn0.gM5hYGxnUI-n_zM-iut8Dml1T5593YhH5A9HNo8hovA';
        
        const DEFAULT_UPI_ID = '7321086174@naviaxis';

        // FIXED: Use a unique variable name to avoid conflict
        let supabase = null;

        // ============================================
        // üåê GLOBAL STATE
        // ============================================
        let currentUser = null;
        let currentUserProfile = null;
        let currentSubscription = null;
        let isAdmin = false;
        let isGodAdmin = false;
        let allPlans = [];
        let appSettings = {};
        let selectedPlanForPayment = null;

        // ============================================
        // üöÄ APP INITIALIZATION
        // ============================================
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ InstaBot Pro Initializing...');
            
            try {
                // Initialize Supabase
                if (window.supabase && window.supabase.createClient) {
                    supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                } else {
                    console.error('Supabase SDK not loaded');
                    return;
                }
                
                // Load app settings
                await loadAppSettings();
                
                // Check for existing session
                const { data: { session } } = await supabase.auth.getSession();
                
                if (session) {
                    await handleUserSession(session);
                } else {
                    showLandingPage();
                }

                // Load plans for landing page
                await loadPlans();

                // Update current year in footer
                const currentYear = document.getElementById('current-year');
                if (currentYear) {
                    currentYear.textContent = new Date().getFullYear();
                }

                // Hide loading screen
                setTimeout(() => {
                    const loadingScreen = document.getElementById('loadingScreen');
                    if (loadingScreen) {
                        loadingScreen.classList.add('hidden');
                    }
                }, 1000);

                // Listen for auth changes
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth state changed:', event);
                    if (event === 'SIGNED_IN' && session) {
                        await handleUserSession(session);
                    } else if (event === 'SIGNED_OUT') {
                        currentUser = null;
                        currentUserProfile = null;
                        showLandingPage();
                    }
                });

            } catch (error) {
                console.error('Initialization error:', error);
                showToast('Failed to initialize app', 'error');
            }
        });

        // ============================================
        // üîê AUTHENTICATION FUNCTIONS
        // ============================================
        
        async function signInWithGoogle() {
            try {
                showToast('Redirecting to Google...', 'info');
                
                const { data, error } = await supabase.auth.signInWithOAuth({
                    provider: 'google',
                    options: {
                        redirectTo: window.location.origin
                    }
                });

                if (error) throw error;
            } catch (error) {
                console.error('Google sign in error:', error);
                showToast('Failed to sign in with Google', 'error');
            }
        }

        // FIXED: Added missing loginWithGoogle function for backward compatibility
        window.loginWithGoogle = signInWithGoogle;

        async function signOut() {
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                
                currentUser = null;
                currentUserProfile = null;
                isAdmin = false;
                isGodAdmin = false;
                
                showLandingPage();
                showToast('Signed out successfully', 'success');
            } catch (error) {
                console.error('Sign out error:', error);
                showToast('Failed to sign out', 'error');
            }
        }

        async function handleUserSession(session) {
            try {
                currentUser = session.user;
                console.log('User logged in:', currentUser.email);

                // Get or create user profile
                await loadUserProfile();

                // Check admin status
                isAdmin = currentUserProfile?.is_admin || false;
                isGodAdmin = currentUserProfile?.is_god_admin || false;

                // Close auth modal if open
                closeAuthModal();

                // Load user's subscription
                await loadUserSubscription();

                // Setup realtime subscriptions
                setupRealtimeSubscriptions();

                // Show appropriate dashboard
                if (isAdmin) {
                    showAdminDashboard();
                } else {
                    showUserDashboard();
                }
            } catch (error) {
                console.error('Session handling error:', error);
                showToast('Failed to load user session', 'error');
            }
        }

        async function loadUserProfile() {
            try {
                // First try to get existing profile
                let { data: profile, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code === 'PGRST116') {
                    // Profile doesn't exist, create it
                    const { data: newProfile, error: createError } = await supabase
                        .from('users')
                        .insert({
                            id: currentUser.id,
                            email: currentUser.email,
                            full_name: currentUser.user_metadata?.full_name || currentUser.user_metadata?.name || '',
                            avatar_url: currentUser.user_metadata?.avatar_url || ''
                        })
                        .select()
                        .single();

                    if (createError) throw createError;
                    profile = newProfile;
                } else if (error) {
                    throw error;
                }

                currentUserProfile = profile;
                return profile;
            } catch (error) {
                console.error('Error loading user profile:', error);
                // Create minimal profile object
                currentUserProfile = {
                    id: currentUser.id,
                    email: currentUser.email,
                    full_name: currentUser.user_metadata?.full_name || '',
                    avatar_url: currentUser.user_metadata?.avatar_url || '',
                    is_admin: false,
                    is_god_admin: false
                };
                return currentUserProfile;
            }
        }

        async function loadUserSubscription() {
            try {
                const { data, error } = await supabase
                    .from('subscriptions')
                    .select(`
                        *,
                        plan:plans(*)
                    `)
                    .eq('user_id', currentUser.id)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false })
                    .limit(1)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                currentSubscription = data;
                return data;
            } catch (error) {
                console.error('Error loading subscription:', error);
                currentSubscription = null;
                return null;
            }
        }

        // ============================================
        // üìä DATA LOADING FUNCTIONS
        // ============================================

        async function loadAppSettings() {
            try {
                const { data, error } = await supabase
                    .from('settings')
                    .select('*');

                if (error) throw error;

                appSettings = {};
                if (data) {
                    data.forEach(setting => {
                        try {
                            appSettings[setting.key] = JSON.parse(setting.value);
                        } catch (e) {
                            appSettings[setting.key] = setting.value;
                        }
                    });
                }

                // Update UPI ID display
                const upiDisplay = document.getElementById('upiIdDisplay');
                if (upiDisplay) {
                    upiDisplay.textContent = (appSettings.upi_id || DEFAULT_UPI_ID).replace(/"/g, '');
                }

            } catch (error) {
                console.error('Error loading settings:', error);
                appSettings = {
                    upi_id: DEFAULT_UPI_ID,
                    site_name: 'InstaBot Pro',
                    maintenance_mode: false,
                    registration_enabled: true
                };
            }
        }

        async function loadPlans() {
            try {
                const { data, error } = await supabase
                    .from('plans')
                    .select('*')
                    .eq('is_active', true)
                    .order('sort_order');

                if (error) throw error;

                allPlans = data || [];
                renderPricingCards();
            } catch (error) {
                console.error('Error loading plans:', error);
                // Use default plans
                allPlans = [
                    { id: '1', name: 'Free', slug: 'free', price: 0, features: ['1 Instagram Account', '100 Actions/Day'], limits: { accounts: 1 } },
                    { id: '2', name: 'Pro', slug: 'pro', price: 199, features: ['5 Instagram Accounts', '1000 Actions/Day'], limits: { accounts: 5 } },
                    { id: '3', name: 'Master', slug: 'master', price: 499, features: ['Unlimited Accounts', 'Unlimited Actions'], limits: { accounts: -1 } }
                ];
                renderPricingCards();
            }
        }

        // ============================================
        // üé® RENDERING FUNCTIONS
        // ============================================

        function renderPricingCards() {
            const pricingGrid = document.getElementById('pricingGrid');
            if (!pricingGrid) return;

            const pricingHtml = allPlans.map(plan => {
                let features = [];
                if (Array.isArray(plan.features)) {
                    features = plan.features;
                } else if (typeof plan.features === 'string') {
                    try {
                        features = JSON.parse(plan.features);
                    } catch (e) {
                        features = [];
                    }
                }
                
                const isPopular = plan.slug === 'pro';
                
                return `
                    <div class="pricing-card ${isPopular ? 'popular' : ''} plan-${plan.slug}">
                        ${isPopular ? '<div class="popular-badge">POPULAR</div>' : ''}
                        <div class="plan-icon">
                            <i class="fas ${plan.slug === 'free' ? 'fa-gift' : plan.slug === 'pro' ? 'fa-rocket' : 'fa-crown'}"></i>
                        </div>
                        <h3 class="plan-name">${plan.name}</h3>
                        <div class="plan-price">
                            <span class="price-currency">‚Çπ</span>
                            <span class="price-amount">${plan.price}</span>
                            <span class="price-period">/month</span>
                        </div>
                        <ul class="plan-features">
                            ${features.map(f => `<li><i class="fas fa-check"></i> ${f}</li>`).join('')}
                        </ul>
                        <button class="btn ${plan.price === 0 ? 'btn-secondary' : 'btn-primary'}" 
                                style="width: 100%;" 
                                onclick="${plan.price === 0 ? 'showAuthModal()' : `selectPlan('${plan.id}')`}">
                            ${plan.price === 0 ? 'Get Started Free' : 'Subscribe Now'}
                        </button>
                    </div>
                `;
            }).join('');

            pricingGrid.innerHTML = pricingHtml;
        }

        // ============================================
        // üñ•Ô∏è UI STATE MANAGEMENT
        // ============================================

        function showLandingPage() {
            const landingPage = document.getElementById('landingPage');
            const userDashboard = document.getElementById('userDashboard');
            const adminDashboard = document.getElementById('adminDashboard');
            
            if (landingPage) landingPage.style.display = 'block';
            if (userDashboard) userDashboard.classList.remove('active');
            if (adminDashboard) adminDashboard.classList.remove('active');
        }

        function showUserDashboard() {
            const landingPage = document.getElementById('landingPage');
            const userDashboard = document.getElementById('userDashboard');
            const adminDashboard = document.getElementById('adminDashboard');
            
            if (landingPage) landingPage.style.display = 'none';
            if (adminDashboard) adminDashboard.classList.remove('active');
            if (userDashboard) userDashboard.classList.add('active');

            // Update UI with user info
            updateDashboardUI();
        }

        function showAdminDashboard() {
            const landingPage = document.getElementById('landingPage');
            const userDashboard = document.getElementById('userDashboard');
            const adminDashboard = document.getElementById('adminDashboard');
            
            if (landingPage) landingPage.style.display = 'none';
            if (userDashboard) userDashboard.classList.remove('active');
            if (adminDashboard) adminDashboard.classList.add('active');

            // Update admin UI
            updateAdminUI();
        }

        function updateDashboardUI() {
            // Update user info
            const userName = document.getElementById('userName');
            if (userName) {
                userName.textContent = currentUserProfile?.full_name || currentUser?.email?.split('@')[0] || 'User';
            }
            
            const userAvatar = document.getElementById('userAvatar');
            if (userAvatar) {
                userAvatar.src = currentUserProfile?.avatar_url || 'https://via.placeholder.com/45';
            }

            // Update plan badge
            const planName = currentSubscription?.plan?.name || 'Free';
            const userPlan = document.getElementById('userPlan');
            if (userPlan) {
                userPlan.textContent = planName;
                userPlan.className = `badge badge-${planName === 'Free' ? 'secondary' : planName === 'Pro' ? 'info' : 'warning'}`;
            }
        }

        function updateAdminUI() {
            const adminName = document.getElementById('adminName');
            if (adminName) {
                adminName.textContent = currentUserProfile?.full_name || 'Admin';
            }
            
            const adminAvatar = document.getElementById('adminAvatar');
            if (adminAvatar) {
                adminAvatar.src = currentUserProfile?.avatar_url || 'https://via.placeholder.com/45';
            }
        }

        // ============================================
        // üîî UTILITY FUNCTIONS
        // ============================================

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');

            if (!toast || !icon || !msg) return;

            msg.textContent = message;
            
            const icons = {
                success: 'fa-check-circle',
                error: 'fa-times-circle',
                warning: 'fa-exclamation-triangle',
                info: 'fa-info-circle'
            };
            
            const colors = {
                success: '#10b981',
                error: '#ef4444',
                warning: '#f59e0b',
                info: '#6366f1'
            };

            icon.className = `fas ${icons[type] || icons.success}`;
            toast.style.borderLeft = `4px solid ${colors[type] || colors.success}`;
            toast.style.display = 'block';

            setTimeout(() => {
                toast.style.display = 'none';
            }, 3000);
        }

        function showAuthModal() {
            const modal = document.getElementById('authModal');
            if (modal) modal.classList.add('active');
        }

        function closeAuthModal() {
            const modal = document.getElementById('authModal');
            if (modal) modal.classList.remove('active');
        }

        function scrollToSection(id) {
            const element = document.getElementById(id);
            if (element) {
                element.scrollIntoView({ behavior: 'smooth' });
            }
        }

        function copyUpiId() {
            const upiDisplay = document.getElementById('upiIdDisplay');
            if (upiDisplay) {
                const upiId = upiDisplay.textContent;
                navigator.clipboard.writeText(upiId).then(() => {
                    showToast('UPI ID copied!', 'success');
                });
            }
        }

        // ============================================
        // üí≥ PAYMENT SYSTEM
        // ============================================

        function selectPlan(planId) {
            if (!currentUser) {
                showAuthModal();
                return;
            }

            const plan = allPlans.find(p => p.id === planId);
            if (!plan) {
                showToast('Plan not found', 'error');
                return;
            }

            if (plan.price === 0) {
                showToast('You already have access to the Free plan', 'info');
                return;
            }

            selectedPlanForPayment = plan;
            openPaymentModal(plan);
        }

        function openPaymentModal(plan) {
            const paymentPlanName = document.getElementById('paymentPlanName');
            if (paymentPlanName) {
                paymentPlanName.textContent = `${plan.name} Plan - ‚Çπ${plan.price}/month`;
            }
            
            const amountPaid = document.getElementById('amountPaid');
            if (amountPaid) amountPaid.value = plan.price;
            
            const transactionId = document.getElementById('transactionId');
            if (transactionId) transactionId.value = '';
            
            // Generate QR Code
            generateQRCode(plan.price);
            
            const modal = document.getElementById('paymentModal');
            if (modal) modal.classList.add('active');
        }

        function closePaymentModal() {
            const modal = document.getElementById('paymentModal');
            if (modal) modal.classList.remove('active');
            selectedPlanForPayment = null;
        }

        function generateQRCode(amount) {
            const upiId = (appSettings.upi_id || DEFAULT_UPI_ID).replace(/"/g, '');
            const qrContainer = document.getElementById('qrCode');
            
            if (!qrContainer) return;
            
            // UPI payment URL format
            const upiUrl = `upi://pay?pa=${upiId}&pn=InstaBot%20Pro&am=${amount}&cu=INR&tn=InstaBot%20Pro%20Subscription`;
            
            // Generate QR using API
            const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiUrl)}`;
            
            qrContainer.innerHTML = `<img src="${qrApiUrl}" alt="Payment QR Code" style="width: 100%; height: 100%; object-fit: contain;">`;
        }

        async function submitPayment(event) {
            event.preventDefault();
            
            const transactionIdInput = document.getElementById('transactionId');
            const amountPaidInput = document.getElementById('amountPaid');
            
            const transactionId = transactionIdInput ? transactionIdInput.value.trim() : '';
            const amountPaid = amountPaidInput ? amountPaidInput.value : 0;

            if (!transactionId) {
                showToast('Please enter transaction ID', 'error');
                return;
            }

            if (!amountPaid || amountPaid <= 0) {
                showToast('Please enter valid amount', 'error');
                return;
            }

            if (!selectedPlanForPayment) {
                showToast('No plan selected', 'error');
                return;
            }

            const submitBtn = document.getElementById('submitPaymentBtn');
            if (submitBtn) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            }

            try {
                // Check for duplicate transaction ID
                const { data: existing } = await supabase
                    .from('payments')
                    .select('id')
                    .eq('transaction_id', transactionId)
                    .single();

                if (existing) {
                    showToast('This transaction ID has already been submitted', 'error');
                    if (submitBtn) {
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Payment';
                    }
                    return;
                }

                // Create payment record
                const { data, error } = await supabase
                    .from('payments')
                    .insert({
                        user_id: currentUser.id,
                        plan_id: selectedPlanForPayment.id,
                        amount: parseFloat(amountPaid),
                        transaction_id: transactionId,
                        status: 'pending',
                        payment_method: 'upi'
                    })
                    .select()
                    .single();

                if (error) throw error;

                showToast('Payment submitted! Awaiting admin verification.', 'success');
                closePaymentModal();

            } catch (error) {
                console.error('Payment submission error:', error);
                showToast('Failed to submit payment. Please try again.', 'error');
            } finally {
                if (submitBtn) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-check"></i> Submit Payment';
                }
            }
        }

        // ============================================
        // üîÑ REALTIME SUBSCRIPTIONS
        // ============================================

        function setupRealtimeSubscriptions() {
            if (!currentUser) return;

            // Listen for subscription changes
            supabase
                .channel('user-subscriptions-' + currentUser.id)
                .on('postgres_changes', {
                    event: '*',
                    schema: 'public',
                    table: 'subscriptions',
                    filter: `user_id=eq.${currentUser.id}`
                }, async (payload) => {
                    await loadUserSubscription();
                    updateDashboardUI();
                    if (payload.new?.status === 'active') {
                        showToast('Your subscription has been activated!', 'success');
                    }
                })
                .subscribe();

            // Listen for payment status changes
            supabase
                .channel('user-payments-' + currentUser.id)
                .on('postgres_changes', {
                    event: 'UPDATE',
                    schema: 'public',
                    table: 'payments',
                    filter: `user_id=eq.${currentUser.id}`
                }, (payload) => {
                    if (payload.new?.status === 'verified') {
                        showToast('Your payment has been verified!', 'success');
                    } else if (payload.new?.status === 'rejected') {
                        showToast('Your payment was rejected. Please contact support.', 'error');
                    }
                })
                .subscribe();
        }

        // Make functions available globally
        window.signInWithGoogle = signInWithGoogle;
        window.showAuthModal = showAuthModal;
        window.closeAuthModal = closeAuthModal;
        window.scrollToSection = scrollToSection;
        window.copyUpiId = copyUpiId;
        window.selectPlan = selectPlan;
        window.closePaymentModal = closePaymentModal;
        window.submitPayment = submitPayment;
        window.makeFirstAdmin = async function() {
            if (!currentUser) {
                alert('Please login first');
                return;
            }
            
            try {
                const { error } = await supabase
                    .from('users')
                    .update({ 
                        is_admin: true, 
                        is_god_admin: true 
                    })
                    .eq('id', currentUser.id);

                if (error) throw error;

                alert('‚úÖ You are now a God Admin! Page will refresh...');
                location.reload();

            } catch (error) {
                console.error('Error:', error);
                alert('Failed to set admin status: ' + error.message);
            }
        };

        console.log('%cüöÄ InstaBot Pro Loaded Successfully!', 'color: #6366f1; font-size: 16px; font-weight: bold;');
        console.log('%cüí° To make yourself admin, login and run: makeFirstAdmin()', 'color: #10b981; font-size: 12px;');
    </script>
</body>
</html>
