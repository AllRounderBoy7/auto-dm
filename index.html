```html
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>InstaBot Pro</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- Animate.css -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"/>

  <style>
    :root{
      --bg0:#070816;
      --bg1:#0b1024;
      --card: rgba(255,255,255,0.08);
      --card2: rgba(255,255,255,0.06);
      --stroke: rgba(255,255,255,0.14);
      --text:#e8eaf6;
      --muted:rgba(232,234,246,0.72);
      --muted2:rgba(232,234,246,0.52);

      --p1:#6366f1;
      --p2:#ec4899;

      --shadow: 0 18px 60px rgba(0,0,0,0.42);
      --blur: 14px;

      --ok:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;

      --radius: 18px;
      --radius2: 14px;
      --maxw: 1180px;

      --sidebarW: 270px;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: Poppins, system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      color:var(--text);
      background: radial-gradient(1200px 700px at 10% 10%, rgba(99,102,241,0.20), transparent 60%),
                  radial-gradient(900px 600px at 90% 20%, rgba(236,72,153,0.18), transparent 62%),
                  radial-gradient(900px 600px at 50% 90%, rgba(99,102,241,0.12), transparent 60%),
                  linear-gradient(180deg, var(--bg0), var(--bg1));
      overflow-x:hidden;
    }

    /* Particle canvas container */
    #particles-js{
      position:fixed;
      inset:0;
      z-index:0;
      opacity:0.55;
      pointer-events:none;
    }

    /* Floating gradient orbs */
    .orbs{
      position:fixed;
      inset:-40px;
      z-index:0;
      pointer-events:none;
      filter: blur(28px);
      opacity:0.95;
      overflow:hidden;
    }
    .orb{
      position:absolute;
      border-radius:999px;
      background: radial-gradient(circle at 30% 30%, rgba(236,72,153,0.78), rgba(99,102,241,0.25), transparent 65%);
      mix-blend-mode: screen;
      animation: floaty 9s ease-in-out infinite;
    }
    .orb.one{ width:420px; height:420px; left:-120px; top:80px; animation-duration: 12s; }
    .orb.two{ width:520px; height:520px; right:-180px; top:220px; animation-duration: 14s; background: radial-gradient(circle at 30% 30%, rgba(99,102,241,0.80), rgba(236,72,153,0.22), transparent 70%); }
    .orb.three{ width:460px; height:460px; left:30%; bottom:-200px; animation-duration: 16s; }
    @keyframes floaty{
      0%,100%{ transform: translate3d(0,0,0) scale(1); }
      50%{ transform: translate3d(30px,-26px,0) scale(1.05); }
    }

    /* Glass helpers */
    .glass{
      background: var(--card);
      border:1px solid var(--stroke);
      backdrop-filter: blur(var(--blur));
      -webkit-backdrop-filter: blur(var(--blur));
      box-shadow: var(--shadow);
      border-radius: var(--radius);
    }
    .glass2{
      background: var(--card2);
      border:1px solid var(--stroke);
      backdrop-filter: blur(calc(var(--blur) - 4px));
      -webkit-backdrop-filter: blur(calc(var(--blur) - 4px));
      border-radius: var(--radius2);
    }

    /* Layout */
    .app{
      position:relative;
      z-index:1;
      min-height:100vh;
      display:flex;
      flex-direction:column;
    }

    .container{
      width: min(var(--maxw), calc(100% - 32px));
      margin:0 auto;
    }

    /* Landing */
    #landing{
      display:none;
      padding: 26px 0 56px;
    }
    .landingTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding: 14px 0 8px;
    }
    .brand{
      display:flex;
      align-items:center;
      gap:10px;
    }
    .logoMark{
      width:38px; height:38px;
      border-radius:14px;
      background: linear-gradient(135deg, var(--p1), var(--p2));
      box-shadow: 0 18px 55px rgba(99,102,241,0.25);
      display:grid;
      place-items:center;
      border:1px solid rgba(255,255,255,0.22);
    }
    .logoMark i{ color:white; }
    .brandTitle{
      font-weight:700;
      letter-spacing:0.2px;
    }
    .pill{
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.15);
      background: rgba(255,255,255,0.05);
      color: var(--muted);
      font-size:12px;
    }

    .hero{
      padding: 44px 0 18px;
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:20px;
      align-items:stretch;
    }
    .hero h1{
      margin:0 0 10px 0;
      font-size: clamp(30px, 5vw, 52px);
      line-height:1.06;
      letter-spacing:-0.6px;
    }
    .gradText{
      background: linear-gradient(90deg, var(--p1), var(--p2));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .hero p{
      margin: 0 0 18px 0;
      color: var(--muted);
      line-height:1.55;
      font-size: 14.5px;
    }
    .heroCard{
      padding:18px;
    }
    .heroActions{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:14px;
    }

    .btn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius: 14px;
      padding: 11px 14px;
      font-weight:600;
      color: var(--text);
      background: rgba(255,255,255,0.08);
      border:1px solid rgba(255,255,255,0.12);
      transition: transform .15s ease, box-shadow .15s ease, background .15s ease, border-color .15s ease;
      display:inline-flex;
      align-items:center;
      gap:10px;
      user-select:none;
      text-decoration:none;
    }
    .btn:hover{ transform: translateY(-1px); border-color: rgba(255,255,255,0.20); background: rgba(255,255,255,0.10); }
    .btn:active{ transform: translateY(0px); }
    .btn.primary{
      background: linear-gradient(135deg, rgba(99,102,241,0.95), rgba(236,72,153,0.95));
      border-color: rgba(255,255,255,0.14);
      box-shadow: 0 20px 60px rgba(99,102,241,0.18);
    }
    .btn.primary:hover{
      box-shadow: 0 26px 70px rgba(236,72,153,0.18);
    }
    .btn.ghost{
      background: rgba(255,255,255,0.06);
    }
    .btn.sm{
      padding: 9px 12px;
      border-radius: 12px;
      font-size: 13px;
    }
    .btn.danger{
      background: rgba(239,68,68,0.14);
      border-color: rgba(239,68,68,0.35);
    }
    .btn.ok{
      background: rgba(34,197,94,0.12);
      border-color: rgba(34,197,94,0.34);
    }

    .heroMini{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .miniStat{
      padding:12px;
    }
    .miniStat .k{ color: var(--muted2); font-size: 12px; margin-bottom: 2px; }
    .miniStat .v{ font-size: 16px; font-weight:700; }

    .features{
      padding: 18px 0 10px;
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .feature{
      padding:16px;
      min-height:120px;
    }
    .feature i{
      font-size:18px;
      margin-bottom:10px;
      background: linear-gradient(90deg, var(--p1), var(--p2));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }
    .feature .t{ font-weight:700; margin-bottom:4px; }
    .feature .d{ color: var(--muted); font-size: 13px; line-height:1.55; }

    .pricing{
      padding: 14px 0 0;
    }
    .pricingHeader{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
      margin: 12px 0;
    }
    .pricingHeader h2{ margin:0; font-size: 22px; }
    .pricingHeader p{ margin:0; color: var(--muted); font-size: 13px; }
    .plans{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    .plan{
      padding:16px;
      position:relative;
      overflow:hidden;
    }
    .plan .tag{
      position:absolute;
      top:14px; right:14px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.20);
      color: var(--muted);
    }
    .plan .name{ font-weight:800; font-size:18px; margin-bottom:6px; }
    .plan .price{
      font-size: 26px;
      font-weight:900;
      letter-spacing:-0.4px;
      margin-bottom: 10px;
    }
    .plan .sub{ color: var(--muted); font-size: 13px; margin-bottom: 12px; }
    .ul{
      list-style:none;
      padding:0; margin:0 0 14px 0;
      display:grid;
      gap:8px;
      color: var(--muted);
      font-size: 13px;
    }
    .ul li{ display:flex; gap:10px; align-items:flex-start; }
    .ul i{ margin-top:2px; color: rgba(255,255,255,0.75); }

    /* App shell */
    #shell{
      display:none;
      min-height:100vh;
    }
    .shellWrap{
      display:flex;
      min-height:100vh;
    }
    .sidebar{
      width: var(--sidebarW);
      padding: 14px;
      position:sticky;
      top:0;
      height:100vh;
      display:flex;
      flex-direction:column;
      gap:12px;
    }
    .sideTop{
      padding: 14px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .sideTitle{ font-weight:800; }
    .sideMeta{ color: var(--muted); font-size: 12px; margin-top:2px; }
    .nav{
      padding: 10px;
      display:grid;
      gap:6px;
    }
    .nav a{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-radius:14px;
      color: var(--muted);
      text-decoration:none;
      border:1px solid transparent;
      background: transparent;
      transition: all .15s ease;
      font-size: 13px;
    }
    .nav a i{ width:18px; text-align:center; }
    .nav a:hover{
      color: var(--text);
      border-color: rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
    }
    .nav a.active{
      color: var(--text);
      background: linear-gradient(135deg, rgba(99,102,241,0.20), rgba(236,72,153,0.14));
      border-color: rgba(255,255,255,0.18);
    }
    .sideFoot{
      margin-top:auto;
      padding: 12px;
      display:grid;
      gap:10px;
    }
    .userChip{
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px;
    }
    .avatar{
      width:34px; height:34px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      object-fit:cover;
    }
    .chipName{ font-weight:700; font-size: 13px; line-height:1.2; }
    .chipEmail{ font-size: 12px; color: var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width: 150px; }

    .content{
      flex:1;
      padding: 14px;
      min-width: 0;
    }
    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px;
      margin-bottom: 12px;
    }
    .crumb{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .hamb{
      display:none;
    }
    .crumbTitle{ font-weight:900; letter-spacing:-0.2px; }
    .crumbSub{ color: var(--muted); font-size: 12px; }

    .grid{
      display:grid;
      gap:12px;
    }
    .stats{
      grid-template-columns: repeat(4, 1fr);
    }
    .card{
      padding: 14px;
    }
    .cardHead{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:10px;
      margin-bottom: 8px;
    }
    .cardHead .label{
      color: var(--muted2);
      font-size: 12px;
    }
    .cardHead .value{
      font-size: 22px;
      font-weight: 900;
      letter-spacing:-0.4px;
      margin-top: 2px;
    }
    .iconBubble{
      width:34px; height:34px;
      border-radius: 14px;
      display:grid;
      place-items:center;
      border:1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
    }
    .iconBubble i{
      background: linear-gradient(90deg, var(--p1), var(--p2));
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
    }

    .split{
      grid-template-columns: 1.1fr 0.9fr;
      align-items:start;
    }

    /* Tables */
    .tableWrap{
      overflow:auto;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.16);
    }
    table{
      width:100%;
      border-collapse: collapse;
      min-width: 720px;
    }
    th, td{
      padding: 12px 12px;
      border-bottom:1px solid rgba(255,255,255,0.08);
      text-align:left;
      font-size: 13px;
      color: var(--muted);
      vertical-align:middle;
    }
    th{
      color: rgba(232,234,246,0.84);
      font-weight:700;
      font-size: 12px;
      letter-spacing: 0.2px;
      background: rgba(255,255,255,0.04);
      position: sticky;
      top:0;
      z-index:1;
    }
    td strong{ color: var(--text); }
    .rowActions{
      display:flex; gap:8px; flex-wrap:wrap;
    }

    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      font-size:12px;
      color: var(--muted);
      white-space:nowrap;
    }
    .dot{
      width:8px;height:8px;border-radius:999px;
      background: rgba(255,255,255,0.55);
    }
    .badge.ok .dot{ background: var(--ok); }
    .badge.warn .dot{ background: var(--warn); }
    .badge.bad .dot{ background: var(--bad); }

    /* Forms */
    .formGrid{
      display:grid;
      gap:10px;
    }
    label{
      font-size: 12px;
      color: var(--muted);
      display:block;
      margin-bottom: 6px;
    }
    input, textarea, select{
      width:100%;
      padding: 11px 12px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.22);
      color: var(--text);
      outline:none;
      transition: border-color .15s ease, box-shadow .15s ease;
      font-family: inherit;
      font-size: 13px;
    }
    textarea{ min-height: 110px; resize: vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(99,102,241,0.55);
      box-shadow: 0 0 0 4px rgba(99,102,241,0.14);
    }
    .help{
      color: var(--muted2);
      font-size: 12px;
      line-height:1.45;
      margin-top: -4px;
    }

    /* Toggle */
    .toggle{
      width: 46px;
      height: 26px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      position:relative;
      cursor:pointer;
      transition: all .18s ease;
      display:inline-block;
      vertical-align:middle;
    }
    .toggle::after{
      content:"";
      position:absolute;
      top:3px; left:3px;
      width:20px; height:20px;
      border-radius:999px;
      background: rgba(255,255,255,0.78);
      transition: all .18s ease;
    }
    .toggle.on{
      background: linear-gradient(135deg, rgba(99,102,241,0.55), rgba(236,72,153,0.45));
      border-color: rgba(255,255,255,0.18);
    }
    .toggle.on::after{
      left: 23px;
      background:white;
    }

    /* Modals */
    .modalOverlay{
      position:fixed;
      inset:0;
      z-index:50;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:flex-end;
      justify-content:center;
      padding: 16px;
    }
    .modal{
      width: min(720px, 100%);
      border-radius: 18px;
      overflow:hidden;
      transform: translateY(12px);
      animation: modalIn .16s ease forwards;
    }
    @keyframes modalIn{
      to{ transform: translateY(0px); }
    }
    .modalHead{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 14px;
      border-bottom:1px solid rgba(255,255,255,0.10);
    }
    .modalHead .title{ font-weight:900; }
    .modalBody{ padding: 14px; }
    .modalFoot{
      padding: 14px;
      border-top:1px solid rgba(255,255,255,0.10);
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }

    /* Toasts */
    .toasts{
      position:fixed;
      right:14px;
      bottom:14px;
      z-index:60;
      display:grid;
      gap:10px;
      width: min(360px, calc(100% - 28px));
    }
    .toast{
      padding: 12px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,0.16);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      background: rgba(16,18,39,0.65);
      box-shadow: 0 18px 60px rgba(0,0,0,0.4);
      display:flex;
      gap:10px;
      align-items:flex-start;
      animation: toastIn .18s ease;
    }
    @keyframes toastIn{
      from{ transform: translateY(6px); opacity:0; }
      to{ transform: translateY(0px); opacity:1; }
    }
    .toast .ic{
      width:32px; height:32px;
      border-radius: 14px;
      display:grid; place-items:center;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      margin-top: 1px;
    }
    .toast .txt{ flex:1; }
    .toast .t{ font-weight:800; font-size: 13px; margin-bottom: 2px; }
    .toast .d{ color: var(--muted); font-size: 12px; line-height: 1.45; }
    .toast.ok .ic{ border-color: rgba(34,197,94,0.35); }
    .toast.ok i{ color: var(--ok); }
    .toast.bad .ic{ border-color: rgba(239,68,68,0.35); }
    .toast.bad i{ color: var(--bad); }
    .toast.warn .ic{ border-color: rgba(245,158,11,0.35); }
    .toast.warn i{ color: var(--warn); }

    /* Loading overlay */
    .loading{
      position:fixed;
      inset:0;
      z-index:70;
      background: rgba(0,0,0,0.55);
      display:none;
      align-items:center;
      justify-content:center;
      padding: 16px;
    }
    .spinner{
      width: 58px;
      height: 58px;
      border-radius: 999px;
      border: 4px solid rgba(255,255,255,0.14);
      border-top-color: rgba(236,72,153,0.85);
      border-right-color: rgba(99,102,241,0.85);
      animation: spin .9s linear infinite;
      box-shadow: 0 18px 60px rgba(0,0,0,0.4);
    }
    @keyframes spin{
      to{ transform: rotate(360deg); }
    }

    /* Page sections in shell */
    .page{ display:none; }
    .page.active{ display:block; }

    /* Message list */
    .msgList{
      display:grid;
      gap:10px;
    }
    .msgItem{
      padding: 12px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .msgItem .p{
      width: 42px; height: 42px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      object-fit:cover;
    }
    .msgItem .meta{ flex:1; min-width:0; }
    .msgItem .meta .top{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      margin-bottom: 4px;
    }
    .msgItem .meta .who{ font-weight:800; font-size: 13px; }
    .msgItem .meta .when{ color: var(--muted2); font-size: 12px; white-space:nowrap; }
    .msgItem .meta .txt{
      color: var(--muted);
      font-size: 13px;
      line-height:1.5;
      overflow:hidden;
      display:-webkit-box;
      -webkit-line-clamp:2;
      -webkit-box-orient: vertical;
    }

    /* Plan lock overlay */
    .lock{
      position:relative;
      overflow:hidden;
    }
    .lock::after{
      content:"Upgrade to unlock";
      position:absolute;
      inset:0;
      display:grid;
      place-items:center;
      color: rgba(232,234,246,0.9);
      font-weight:900;
      background: rgba(0,0,0,0.48);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      border:1px solid rgba(255,255,255,0.10);
    }

    /* Responsive */
    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
      .features{ grid-template-columns: 1fr; }
      .plans{ grid-template-columns: 1fr; }
      .stats{ grid-template-columns: 1fr 1fr; }
      .split{ grid-template-columns: 1fr; }
    }
    @media (max-width: 860px){
      .sidebar{
        position:fixed;
        left:14px;
        top:14px;
        height: calc(100vh - 28px);
        transform: translateX(calc(-100% - 28px));
        transition: transform .18s ease;
        z-index:40;
        width: min(var(--sidebarW), calc(100% - 28px));
      }
      .sidebar.open{ transform: translateX(0); }
      .hamb{
        display:inline-flex;
      }
      .content{ padding: 14px; }
      table{ min-width: 860px; } /* keep readable */
    }
    @media (max-width: 520px){
      .stats{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body>
  <div id="particles-js"></div>
  <div class="orbs" aria-hidden="true">
    <div class="orb one"></div>
    <div class="orb two"></div>
    <div class="orb three"></div>
  </div>

  <div class="app">
    <!-- LANDING -->
    <section id="landing" class="animate__animated animate__fadeIn">
      <div class="container">
        <div class="landingTop">
          <div class="brand">
            <div class="logoMark"><i class="fa-solid fa-bolt"></i></div>
            <div>
              <div class="brandTitle">InstaBot Pro</div>
              <div class="pill">Instagram automation SaaS</div>
            </div>
          </div>

          <div style="display:flex; gap:10px; align-items:center;">
            <a class="btn ghost sm" href="#pricing"><i class="fa-solid fa-tags"></i> Pricing</a>
            <button id="btnLoginGoogle" class="btn primary sm"><i class="fa-brands fa-google"></i> Continue with Google</button>
          </div>
        </div>

        <div class="hero">
          <div class="glass heroCard animate__animated animate__fadeInUp">
            <h1>Automate Instagram DMs and comments with <span class="gradText">InstaBot Pro</span></h1>
            <p>
              Build keyword automations, manage contacts, track performance, and handle billing.
              Google OAuth login only. Supabase backend. PhonePe UPI upgrade flow.
            </p>

            <div class="heroActions">
              <button class="btn primary" id="btnHeroLogin"><i class="fa-brands fa-google"></i> Start free</button>
              <a class="btn" href="#features"><i class="fa-solid fa-wand-magic-sparkles"></i> See features</a>
            </div>

            <div class="heroMini">
              <div class="glass2 miniStat">
                <div class="k">Triggers</div>
                <div class="v">DM, comment, stories</div>
              </div>
              <div class="glass2 miniStat">
                <div class="k">Theme</div>
                <div class="v">Dark glass UI</div>
              </div>
            </div>
          </div>

          <div class="glass heroCard animate__animated animate__fadeInUp" style="animation-delay:.06s;">
            <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
              <div>
                <div style="font-weight:900; font-size:16px;">What you get</div>
                <div style="color:var(--muted); font-size:12px; margin-top:2px;">Mobile-first dashboard</div>
              </div>
              <span class="badge"><span class="dot"></span> Live + Realtime ready</span>
            </div>

            <div class="features" id="features" style="grid-template-columns:1fr; margin-top:12px;">
              <div class="glass2 feature">
                <i class="fa-solid fa-robot"></i>
                <div class="t">Automation Builder</div>
                <div class="d">Create keyword triggers and automatic replies with plan limits enforced.</div>
              </div>
              <div class="glass2 feature">
                <i class="fa-solid fa-address-book"></i>
                <div class="t">Contacts + Tags</div>
                <div class="d">Add contacts, tag them, and track last message time.</div>
              </div>
              <div class="glass2 feature">
                <i class="fa-solid fa-credit-card"></i>
                <div class="t">Billing</div>
                <div class="d">PhonePe UPI intent link, manual verification, payment history.</div>
              </div>
            </div>
          </div>
        </div>

        <div class="pricing" id="pricing">
          <div class="pricingHeader">
            <div>
              <h2>Pricing</h2>
              <p>Upgrade anytime. Limits enforced when creating automations/contacts.</p>
            </div>
            <button class="btn sm" id="btnPricingLogin"><i class="fa-brands fa-google"></i> Login</button>
          </div>

          <div class="plans">
            <div class="glass plan">
              <div class="tag">Free</div>
              <div class="name">Free</div>
              <div class="price">₹0</div>
              <div class="sub">For testing basics</div>
              <ul class="ul">
                <li><i class="fa-solid fa-check"></i> 1,000 contacts</li>
                <li><i class="fa-solid fa-check"></i> 3 automations</li>
                <li><i class="fa-solid fa-check"></i> 1 team member</li>
              </ul>
              <button class="btn primary" id="btnGetStartedFree"><i class="fa-solid fa-arrow-right"></i> Get started</button>
            </div>

            <div class="glass plan" style="border-color: rgba(236,72,153,0.28); background: rgba(236,72,153,0.08);">
              <div class="tag">Popular</div>
              <div class="name">Pro</div>
              <div class="price">₹199<span style="font-size:12px; font-weight:700; color:var(--muted);">/month</span></div>
              <div class="sub">For growing creators</div>
              <ul class="ul">
                <li><i class="fa-solid fa-check"></i> 10,000 contacts</li>
                <li><i class="fa-solid fa-check"></i> 25 automations</li>
                <li><i class="fa-solid fa-check"></i> 5 team members</li>
              </ul>
              <button class="btn primary" id="btnChoosePro"><i class="fa-solid fa-bolt"></i> Choose Pro</button>
            </div>

            <div class="glass plan">
              <div class="tag">Unlimited</div>
              <div class="name">Master</div>
              <div class="price">₹499<span style="font-size:12px; font-weight:700; color:var(--muted);">/month</span></div>
              <div class="sub">For agencies</div>
              <ul class="ul">
                <li><i class="fa-solid fa-check"></i> Unlimited contacts</li>
                <li><i class="fa-solid fa-check"></i> Unlimited automations</li>
                <li><i class="fa-solid fa-check"></i> Unlimited team</li>
              </ul>
              <button class="btn primary" id="btnChooseMaster"><i class="fa-solid fa-crown"></i> Choose Master</button>
            </div>
          </div>

          <div style="margin-top:14px; color:var(--muted2); font-size:12px; line-height:1.55;">
            Note: Instagram API connection is shown in Settings. Real Instagram messaging requires server-side Meta APIs and app review;
            this frontend stores connection status/token fields in Supabase as per your schema.
          </div>
        </div>
      </div>
    </section>

    <!-- APP SHELL -->
    <section id="shell">
      <div class="shellWrap">
        <aside id="sidebar" class="sidebar glass animate__animated animate__fadeInLeft">
          <div class="sideTop glass2">
            <div class="logoMark"><i class="fa-solid fa-bolt"></i></div>
            <div style="min-width:0;">
              <div class="sideTitle">InstaBot Pro</div>
              <div class="sideMeta"><span id="planBadge" class="badge"><span class="dot"></span> free</span></div>
            </div>
          </div>

          <nav class="nav glass2" id="nav">
            <a href="#/dashboard" data-route="dashboard"><i class="fa-solid fa-chart-line"></i> Dashboard</a>
            <a href="#/automations" data-route="automations"><i class="fa-solid fa-robot"></i> Automations</a>
            <a href="#/contacts" data-route="contacts"><i class="fa-solid fa-address-book"></i> Contacts</a>
            <a href="#/inbox" data-route="inbox"><i class="fa-solid fa-inbox"></i> Inbox</a>
            <a href="#/analytics" data-route="analytics"><i class="fa-solid fa-chart-pie"></i> Analytics</a>
            <a href="#/settings" data-route="settings"><i class="fa-solid fa-gear"></i> Settings</a>
            <a href="#/billing" data-route="billing"><i class="fa-solid fa-credit-card"></i> Billing</a>
            <a href="#/admin" data-route="admin" id="navAdmin" style="display:none;"><i class="fa-solid fa-shield-halved"></i> Admin Panel</a>
          </nav>

          <div class="sideFoot glass2">
            <div class="userChip">
              <img id="userAvatar" class="avatar" alt="avatar" />
              <div style="min-width:0;">
                <div id="userName" class="chipName">—</div>
                <div id="userEmail" class="chipEmail">—</div>
              </div>
            </div>
            <button class="btn sm" id="btnLogout"><i class="fa-solid fa-right-from-bracket"></i> Logout</button>
          </div>
        </aside>

        <main class="content">
          <div class="topbar glass">
            <div class="crumb">
              <button class="btn sm hamb" id="btnHamb"><i class="fa-solid fa-bars"></i></button>
              <div>
                <div class="crumbTitle" id="pageTitle">Dashboard</div>
                <div class="crumbSub" id="pageSub">Overview</div>
              </div>
            </div>
            <div style="display:flex; gap:10px; align-items:center; flex-wrap:wrap;">
              <span class="badge" id="igStatusBadge"><span class="dot"></span> Instagram: unknown</span>
              <button class="btn sm primary" id="btnQuickUpgrade"><i class="fa-solid fa-arrow-up-right-dots"></i> Upgrade</button>
            </div>
          </div>

          <!-- DASHBOARD -->
          <section class="page active" id="page-dashboard">
            <div class="grid stats">
              <div class="glass card animate__animated animate__fadeInUp">
                <div class="cardHead">
                  <div>
                    <div class="label">Total contacts</div>
                    <div class="value" id="statContacts">0</div>
                  </div>
                  <div class="iconBubble"><i class="fa-solid fa-address-book"></i></div>
                </div>
                <div class="help" id="statContactsHelp">Limit: —</div>
              </div>

              <div class="glass card animate__animated animate__fadeInUp" style="animation-delay:.03s;">
                <div class="cardHead">
                  <div>
                    <div class="label">Total automations</div>
                    <div class="value" id="statAutomations">0</div>
                  </div>
                  <div class="iconBubble"><i class="fa-solid fa-robot"></i></div>
                </div>
                <div class="help" id="statAutomationsHelp">Limit: —</div>
              </div>

              <div class="glass card animate__animated animate__fadeInUp" style="animation-delay:.06s;">
                <div class="cardHead">
                  <div>
                    <div class="label">Messages sent</div>
                    <div class="value" id="statMessages">0</div>
                  </div>
                  <div class="iconBubble"><i class="fa-solid fa-paper-plane"></i></div>
                </div>
                <div class="help">Counted from messages table</div>
              </div>

              <div class="glass card animate__animated animate__fadeInUp" style="animation-delay:.09s;">
                <div class="cardHead">
                  <div>
                    <div class="label">Today's triggers</div>
                    <div class="value" id="statTodayTriggers">0</div>
                  </div>
                  <div class="iconBubble"><i class="fa-solid fa-bolt"></i></div>
                </div>
                <div class="help">Based on automations.stats.triggered (today not stored; this is a simple placeholder)</div>
              </div>
            </div>

            <div class="grid split" style="margin-top:12px;">
              <div class="glass card">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                  <div>
                    <div style="font-weight:900; font-size:15px;">Quick actions</div>
                    <div style="color:var(--muted); font-size:12px; margin-top:2px;">Create automation or add contact</div>
                  </div>
                  <span class="badge" id="planExpiryBadge"><span class="dot"></span> expiry: —</span>
                </div>

                <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:12px;">
                  <button class="btn primary" id="btnOpenCreateAutomation"><i class="fa-solid fa-plus"></i> New Automation</button>
                  <button class="btn" id="btnOpenAddContact"><i class="fa-solid fa-user-plus"></i> Add Contact</button>
                  <a class="btn" href="#/billing"><i class="fa-solid fa-credit-card"></i> Billing</a>
                  <a class="btn" href="#/inbox"><i class="fa-solid fa-inbox"></i> Inbox</a>
                </div>
              </div>

              <div class="glass card">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:flex-start;">
                  <div>
                    <div style="font-weight:900; font-size:15px;">Instagram connection</div>
                    <div style="color:var(--muted); font-size:12px; margin-top:2px;">Status from your user profile</div>
                  </div>
                  <span class="badge" id="igStatusBadge2"><span class="dot"></span> —</span>
                </div>

                <div style="margin-top:12px; display:grid; gap:10px;">
                  <div class="glass2" style="padding:12px;">
                    <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                      <div>
                        <div style="font-weight:800; font-size:13px;">Connected account</div>
                        <div style="color:var(--muted); font-size:12px;" id="igUsername">—</div>
                      </div>
                      <a class="btn sm" href="#/settings"><i class="fa-solid fa-link"></i> Manage</a>
                    </div>
                  </div>

                  <div class="glass2" style="padding:12px;">
                    <div style="color:var(--muted); font-size:12px; line-height:1.55;">
                      Important: Real DM sending requires server-side Instagram Graph API and webhooks.
                      This UI manages automations/contacts/messages as per your schema and is ready for backend webhook integration.
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- AUTOMATIONS -->
          <section class="page" id="page-automations">
            <div class="glass card">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                <div>
                  <div style="font-weight:900; font-size:15px;">Automations</div>
                  <div style="color:var(--muted); font-size:12px;">Create, toggle, and delete automations</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn primary" id="btnCreateAutomation"><i class="fa-solid fa-plus"></i> Create automation</button>
                  <button class="btn" id="btnRefreshAutomations"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>
              </div>

              <div style="margin-top:12px;" class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th>Name</th>
                      <th>Trigger type</th>
                      <th>Keywords</th>
                      <th>Status</th>
                      <th>Triggered</th>
                      <th>Replied</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="automationsTbody">
                    <tr><td colspan="7">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- CONTACTS -->
          <section class="page" id="page-contacts">
            <div class="glass card">
              <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                <div>
                  <div style="font-weight:900; font-size:15px;">Contacts</div>
                  <div style="color:var(--muted); font-size:12px;">Add, tag, and delete contacts</div>
                </div>
                <div style="display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn primary" id="btnAddContact"><i class="fa-solid fa-user-plus"></i> Add contact</button>
                  <button class="btn" id="btnRefreshContacts"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>
              </div>

              <div style="margin-top:12px;" class="tableWrap">
                <table>
                  <thead>
                    <tr>
                      <th>Profile</th>
                      <th>Username</th>
                      <th>Tags</th>
                      <th>Last message</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="contactsTbody">
                    <tr><td colspan="5">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </section>

          <!-- INBOX -->
          <section class="page" id="page-inbox">
            <div class="grid split">
              <div class="glass card">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                  <div>
                    <div style="font-weight:900; font-size:15px;">Inbox</div>
                    <div style="color:var(--muted); font-size:12px;">Latest messages</div>
                  </div>
                  <button class="btn sm" id="btnRefreshInbox"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>

                <div class="msgList" id="inboxList" style="margin-top:12px;">
                  <div class="glass2 msgItem">Loading…</div>
                </div>
              </div>

              <div class="glass card">
                <div style="font-weight:900; font-size:15px;">Compose (placeholder)</div>
                <div style="color:var(--muted); font-size:12px; margin-top:2px;">
                  Actual Instagram send requires server-side integration. This stores a message row in Supabase.
                </div>

                <div style="margin-top:12px;" class="formGrid">
                  <div>
                    <label>Contact (by username)</label>
                    <input id="composeUsername" placeholder="e.g. john_doe" />
                    <div class="help">We find the first matching contact under your account.</div>
                  </div>
                  <div>
                    <label>Message</label>
                    <textarea id="composeContent" placeholder="Type message…"></textarea>
                  </div>
                  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;">
                    <button class="btn" id="btnComposeSave"><i class="fa-solid fa-floppy-disk"></i> Save to Inbox</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- ANALYTICS -->
          <section class="page" id="page-analytics">
            <div class="grid split">
              <div class="glass card" id="analyticsMain">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                  <div>
                    <div style="font-weight:900; font-size:15px;">Analytics</div>
                    <div style="color:var(--muted); font-size:12px;">Plan-based access</div>
                  </div>
                  <span class="badge" id="analyticsAccess"><span class="dot"></span> —</span>
                </div>

                <div style="margin-top:12px; display:grid; gap:12px;">
                  <div class="glass2" style="padding:12px;">
                    <div style="font-weight:800; font-size:13px;">Automation performance</div>
                    <div style="color:var(--muted); font-size:12px; margin-top:4px;">
                      Aggregated from automations.stats. (For real “today” metrics, store daily counters server-side.)
                    </div>
                    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                      <span class="badge"><span class="dot"></span> Total Triggered: <strong id="anaTriggered" style="color:var(--text); margin-left:6px;">0</strong></span>
                      <span class="badge"><span class="dot"></span> Total Replied: <strong id="anaReplied" style="color:var(--text); margin-left:6px;">0</strong></span>
                    </div>
                  </div>

                  <div class="glass2" style="padding:12px;">
                    <div style="font-weight:800; font-size:13px;">Message breakdown</div>
                    <div style="color:var(--muted); font-size:12px; margin-top:4px;">
                      Automated vs manual based on messages.is_automated.
                    </div>
                    <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
                      <span class="badge"><span class="dot"></span> Automated: <strong id="anaAuto" style="color:var(--text); margin-left:6px;">0</strong></span>
                      <span class="badge"><span class="dot"></span> Manual: <strong id="anaManual" style="color:var(--text); margin-left:6px;">0</strong></span>
                    </div>
                  </div>
                </div>
              </div>

              <div class="glass card">
                <div style="font-weight:900; font-size:15px;">Upgrade for more</div>
                <div style="color:var(--muted); font-size:12px; margin-top:2px;">
                  Free plan can show limited analytics. Pro/Master unlock full analytics.
                </div>
                <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn primary" id="btnAnaUpgrade"><i class="fa-solid fa-arrow-up-right-dots"></i> Upgrade</button>
                  <a class="btn" href="#/billing"><i class="fa-solid fa-credit-card"></i> Billing</a>
                </div>
              </div>
            </div>
          </section>

          <!-- SETTINGS -->
          <section class="page" id="page-settings">
            <div class="grid split">
              <div class="glass card">
                <div style="font-weight:900; font-size:15px;">Profile</div>
                <div style="color:var(--muted); font-size:12px; margin-top:2px;">From Google OAuth and users table</div>

                <div style="margin-top:12px;" class="formGrid">
                  <div>
                    <label>Name</label>
                    <input id="setName" />
                  </div>
                  <div>
                    <label>Avatar URL</label>
                    <input id="setAvatarUrl" placeholder="https://…" />
                  </div>
                  <div style="display:flex; gap:10px; justify-content:flex-end; flex-wrap:wrap;">
                    <button class="btn primary" id="btnSaveProfile"><i class="fa-solid fa-floppy-disk"></i> Save</button>
                  </div>
                </div>
              </div>

              <div class="glass card">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                  <div>
                    <div style="font-weight:900; font-size:15px;">Instagram connection</div>
                    <div style="color:var(--muted); font-size:12px; margin-top:2px;">Stores fields in users table</div>
                  </div>
                  <span class="badge" id="igStatusBadge3"><span class="dot"></span> —</span>
                </div>

                <div style="margin-top:12px;" class="formGrid">
                  <div>
                    <label>Instagram username</label>
                    <input id="igUser" placeholder="@yourhandle" />
                  </div>
                  <div>
                    <label>Instagram token</label>
                    <input id="igToken" placeholder="Paste token (stored in DB)" />
                    <div class="help">Do not store service-role keys here. Use Meta APIs server-side for production messaging.</div>
                  </div>
                  <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:space-between;">
                    <button class="btn" id="btnDisconnectIg"><i class="fa-solid fa-link-slash"></i> Disconnect</button>
                    <button class="btn primary" id="btnSaveIg"><i class="fa-solid fa-link"></i> Save connection</button>
                  </div>
                </div>
              </div>
            </div>
          </section>

          <!-- BILLING -->
          <section class="page" id="page-billing">
            <div class="grid split">
              <div class="glass card">
                <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:10px;">
                  <div>
                    <div style="font-weight:900; font-size:15px;">Subscription</div>
                    <div style="color:var(--muted); font-size:12px; margin-top:2px;">PhonePe UPI (manual verification flow)</div>
                  </div>
                  <span class="badge" id="billingPlanBadge"><span class="dot"></span> —</span>
                </div>

                <div style="margin-top:12px;" class="glass2" style="padding:12px;">
                  <div style="display:grid; gap:6px; color:var(--muted); font-size:13px;">
                    <div>Current plan: <strong id="curPlan" style="color:var(--text);">—</strong></div>
                    <div>Expiry: <strong id="curExpiry" style="color:var(--text);">—</strong></div>
                  </div>
                </div>

                <div style="margin-top:12px; display:flex; gap:10px; flex-wrap:wrap;">
                  <button class="btn primary" id="btnUpgradePro"><i class="fa-solid fa-bolt"></i> Upgrade to Pro</button>
                  <button class="btn primary" id="btnUpgradeMaster"><i class="fa-solid fa-crown"></i> Upgrade to Master</button>
                </div>

                <div style="margin-top:12px; color:var(--muted2); font-size:12px; line-height:1.55;">
                  This frontend creates a subscription row with <code>payment_status=pending</code> and shows a UPI intent URL.
                  Admin verifies payment and marks it success (RLS must allow admin).
                </div>
              </div>

              <div class="glass card">
                <div style="display:flex; justify-content:space-between; align-items:center; gap:10px;">
                  <div>
                    <div style="font-weight:900; font-size:15px;">Payment history</div>
                    <div style="color:var(--muted); font-size:12px; margin-top:2px;">From subscriptions table</div>
                  </div>
                  <button class="btn sm" id="btnRefreshBilling"><i class="fa-solid fa-rotate"></i> Refresh</button>
                </div>

                <div style="margin-top:12px;" class="tableWrap">
                  <table>
                    <thead>
                      <tr>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Transaction</th>
                        <th>Status</th>
                        <th>Created</th>
                      </tr>
                    </thead>
                    <tbody id="subsTbody">
                      <tr><td colspan="5">Loading…</td></tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </section>

          <!-- ADMIN -->
          <section class="page" id="page-admin">
            <div class="glass card">
              <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
                <div>
                  <div style="font-weight:900; font-size:15px;">Admin Panel</div>
                  <div style="color:var(--muted); font-size:12px; margin-top:2px;">
                    Requires <code>users.is_admin=true</code> and correct Supabase RLS.
                    No service-role key is used in this frontend.
                  </div>
                </div>
                <button class="btn sm" id="btnRefreshAdmin"><i class="fa-solid fa-rotate"></i> Refresh</button>
              </div>

              <div class="grid stats" style="margin-top:12px;">
                <div class="glass2 card" style="box-shadow:none;">
                  <div class="cardHead">
                    <div>
                      <div class="label">Total users</div>
                      <div class="value" id="admTotalUsers">—</div>
                    </div>
                    <div class="iconBubble"><i class="fa-solid fa-users"></i></div>
                  </div>
                </div>
                <div class="glass2 card" style="box-shadow:none;">
                  <div class="cardHead">
                    <div>
                      <div class="label">Revenue (success)</div>
                      <div class="value" id="admRevenue">—</div>
                    </div>
                    <div class="iconBubble"><i class="fa-solid fa-indian-rupee-sign"></i></div>
                  </div>
                </div>
                <div class="glass2 card" style="box-shadow:none;">
                  <div class="cardHead">
                    <div>
                      <div class="label">Pro users</div>
                      <div class="value" id="admProUsers">—</div>
                    </div>
                    <div class="iconBubble"><i class="fa-solid fa-bolt"></i></div>
                  </div>
                </div>
                <div class="glass2 card" style="box-shadow:none;">
                  <div class="cardHead">
                    <div>
                      <div class="label">Master users</div>
                      <div class="value" id="admMasterUsers">—</div>
                    </div>
                    <div class="iconBubble"><i class="fa-solid fa-crown"></i></div>
                  </div>
                </div>
              </div>

              <div class="grid split" style="margin-top:12px;">
                <div class="glass2 card" style="box-shadow:none;">
                  <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                    <div>
                      <div style="font-weight:900;">Plans</div>
                      <div style="color:var(--muted); font-size:12px;">Edit limits and prices</div>
                    </div>
                    <button class="btn sm primary" id="btnOpenEditPlan"><i class="fa-solid fa-pen"></i> Edit plan</button>
                  </div>

                  <div style="margin-top:12px;" class="tableWrap">
                    <table style="min-width: 560px;">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Price</th>
                          <th>Contacts</th>
                          <th>Automations</th>
                          <th>Team</th>
                        </tr>
                      </thead>
                      <tbody id="plansTbody">
                        <tr><td colspan="5">Loading…</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>

                <div class="glass2 card" style="box-shadow:none;">
                  <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                    <div>
                      <div style="font-weight:900;">Users</div>
                      <div style="color:var(--muted); font-size:12px;">Change plan manually</div>
                    </div>
                  </div>

                  <div style="margin-top:12px;" class="tableWrap">
                    <table>
                      <thead>
                        <tr>
                          <th>User</th>
                          <th>Plan</th>
                          <th>Expiry</th>
                          <th>Admin</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody id="usersTbody">
                        <tr><td colspan="5">Loading…</td></tr>
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>

              <div class="glass2 card" style="box-shadow:none; margin-top:12px;">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center;">
                  <div>
                    <div style="font-weight:900;">Pending subscriptions</div>
                    <div style="color:var(--muted); font-size:12px;">Verify payment, mark success, update user plan</div>
                  </div>
                </div>

                <div style="margin-top:12px;" class="tableWrap">
                  <table>
                    <thead>
                      <tr>
                        <th>User</th>
                        <th>Plan</th>
                        <th>Amount</th>
                        <th>Transaction</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Action</th>
                      </tr>
                    </thead>
                    <tbody id="pendingSubsTbody">
                      <tr><td colspan="7">Loading…</td></tr>
                    </tbody>
                  </table>
                </div>

                <div style="margin-top:10px; color:var(--muted2); font-size:12px; line-height:1.55;">
                  Payment verification is manual here. For production, implement PhonePe server callbacks/webhooks and signature validation server-side.
                </div>
              </div>
            </div>
          </section>

          <div style="height:18px;"></div>
        </main>
      </div>
    </section>
  </div>

  <!-- MODALS -->
  <div class="modalOverlay" id="modalOverlay">
    <div class="modal glass animate__animated animate__fadeInUp" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <div class="modalHead">
        <div class="title" id="modalTitle">Modal</div>
        <button class="btn sm" id="btnCloseModal"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modalBody" id="modalBody"></div>
      <div class="modalFoot" id="modalFoot"></div>
    </div>
  </div>

  <!-- TOASTS -->
  <div class="toasts" id="toasts"></div>

  <!-- LOADING -->
  <div class="loading" id="loading">
    <div class="spinner" aria-label="Loading"></div>
  </div>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.min.js"></script>
  <!-- Particles.js -->
  <script src="https://cdn.jsdelivr.net/particles.js/2.0.0/particles.min.js"></script>

  <script>
    // ============================================
    // CONFIGURATION - USER MUST UPDATE THESE
    // ============================================
    const SUPABASE_URL = 'https://uvnksakgjupnivmfkjcv.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2bmtzYWtnanVwbml2bWZramN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NzM5NzYsImV4cCI6MjA4MTQ0OTk3Nn0.gM5hYGxnUI-n_zM-iut8Dml1T5593YhH5A9HNo8hovA';
    const UPI_ID = 'your-upi@ybl'; // set your merchant UPI ID
    const UPI_PAYEE_NAME = 'InstaBot Pro';
    // ============================================

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
      auth: {
        persistSession: true,
        autoRefreshToken: true,
        detectSessionInUrl: true
      }
    });

    const state = {
      session: null,
      authUser: null,
      profile: null,
      plans: [],
      route: 'dashboard',
      isAdmin: false,
      limits: { contacts_limit: 1000, automations_limit: 3, team_members_limit: 1 },
    };

    const $ = (id) => document.getElementById(id);

    function showLoading(on){
      $('loading').style.display = on ? 'flex' : 'none';
    }

    function fmtDate(ts){
      if(!ts) return '—';
      try{
        const d = new Date(ts);
        return d.toLocaleString();
      }catch{ return String(ts); }
    }

    function toast(type, title, desc, ms=3300){
      const wrap = $('toasts');
      const el = document.createElement('div');
      el.className = `toast ${type}`;
      const icon = type === 'ok' ? 'circle-check' : type === 'bad' ? 'circle-xmark' : 'triangle-exclamation';
      el.innerHTML = `
        <div class="ic"><i class="fa-solid fa-${icon}"></i></div>
        <div class="txt">
          <div class="t">${escapeHtml(title || '')}</div>
          <div class="d">${escapeHtml(desc || '')}</div>
        </div>
        <button class="btn sm" style="padding:7px 10px; border-radius:12px;" aria-label="Close"><i class="fa-solid fa-xmark"></i></button>
      `;
      const btn = el.querySelector('button');
      btn.onclick = () => el.remove();
      wrap.appendChild(el);
      setTimeout(() => { if(el.isConnected) el.remove(); }, ms);
    }

    function escapeHtml(s){
      return String(s ?? '')
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#39;");
    }

    function setActiveNav(route){
      document.querySelectorAll('#nav a').forEach(a => {
        a.classList.toggle('active', a.dataset.route === route);
      });
    }

    function setPage(route){
      state.route = route;
      const map = {
        dashboard: ['Dashboard', 'Overview'],
        automations: ['Automations', 'Create, toggle, delete'],
        contacts: ['Contacts', 'Manage your audience'],
        inbox: ['Inbox', 'Latest messages'],
        analytics: ['Analytics', 'Plan-based access'],
        settings: ['Settings', 'Profile & Instagram connection'],
        billing: ['Billing', 'Subscription & payments'],
        admin: ['Admin Panel', 'Platform control'],
      };
      const [t, s] = map[route] || ['Dashboard','Overview'];
      $('pageTitle').textContent = t;
      $('pageSub').textContent = s;

      document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
      const page = $(`page-${route}`);
      if(page) page.classList.add('active');

      setActiveNav(route);
      closeSidebar();

      // page-specific loads
      if(route === 'dashboard') refreshDashboard();
      if(route === 'automations') loadAutomations();
      if(route === 'contacts') loadContacts();
      if(route === 'inbox') loadInbox();
      if(route === 'analytics') loadAnalytics();
      if(route === 'settings') fillSettings();
      if(route === 'billing') loadBilling();
      if(route === 'admin') loadAdmin();
    }

    function getRouteFromHash(){
      const h = location.hash || '#/dashboard';
      const m = h.match(/^#\/([a-z-]+)/i);
      return (m && m[1]) ? m[1] : 'dashboard';
    }

    function openSidebar(){
      $('sidebar').classList.add('open');
    }
    function closeSidebar(){
      $('sidebar').classList.remove('open');
    }

    function openModal(title, bodyHtml, footButtons){
      $('modalTitle').textContent = title;
      $('modalBody').innerHTML = bodyHtml;
      const foot = $('modalFoot');
      foot.innerHTML = '';
      (footButtons || []).forEach(btn => foot.appendChild(btn));
      $('modalOverlay').style.display = 'flex';
    }
    function closeModal(){
      $('modalOverlay').style.display = 'none';
      $('modalBody').innerHTML = '';
      $('modalFoot').innerHTML = '';
    }

    function button(text, cls, icon, onClick){
      const b = document.createElement('button');
      b.className = `btn ${cls || ''}`.trim();
      b.innerHTML = `${icon ? `<i class="fa-solid fa-${icon}"></i>` : ''} ${escapeHtml(text)}`;
      b.onclick = onClick;
      return b;
    }

    async function signInGoogle(){
      try{
        showLoading(true);
        const { error } = await supabase.auth.signInWithOAuth({
          provider: 'google',
          options: { redirectTo: window.location.origin + window.location.pathname }
        });
        if(error) throw error;
      }catch(e){
        toast('bad', 'Login failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function logout(){
      try{
        showLoading(true);
        const { error } = await supabase.auth.signOut();
        if(error) throw error;
        toast('ok','Logged out','You have been signed out.');
      }catch(e){
        toast('bad','Logout failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    function planMeta(planType){
      const p = state.plans.find(x => (x.name || '').toLowerCase() === String(planType || '').toLowerCase());
      if(p) return p;
      // fallback
      const t = (planType || 'free').toLowerCase();
      if(t === 'pro') return { name:'pro', price:199, contacts_limit:10000, automations_limit:25, team_members_limit:5 };
      if(t === 'master') return { name:'master', price:499, contacts_limit:-1, automations_limit:-1, team_members_limit:-1 };
      return { name:'free', price:0, contacts_limit:1000, automations_limit:3, team_members_limit:1 };
    }

    function setBadges(){
      const ptype = (state.profile?.plan_type || 'free').toLowerCase();
      const connected = !!state.profile?.instagram_connected;

      const plan = planMeta(ptype);
      state.limits = {
        contacts_limit: plan.contacts_limit,
        automations_limit: plan.automations_limit,
        team_members_limit: plan.team_members_limit,
      };

      const planText = ` ${ptype}`;
      $('planBadge').innerHTML = `<span class="dot"></span>${escapeHtml(planText)}`;
      $('billingPlanBadge').innerHTML = `<span class="dot"></span>${escapeHtml(planText)}`;
      $('planExpiryBadge').innerHTML = `<span class="dot"></span> expiry: ${escapeHtml(state.profile?.plan_expiry ? new Date(state.profile.plan_expiry).toLocaleDateString() : '—')}`;

      const igTxt = connected ? `Instagram: connected` : `Instagram: not connected`;
      const igCls = connected ? 'ok' : 'warn';
      $('igStatusBadge').className = `badge ${igCls}`;
      $('igStatusBadge2').className = `badge ${igCls}`;
      $('igStatusBadge3').className = `badge ${igCls}`;
      $('igStatusBadge').innerHTML = `<span class="dot"></span> ${escapeHtml(igTxt)}`;
      $('igStatusBadge2').innerHTML = `<span class="dot"></span> ${escapeHtml(igTxt)}`;
      $('igStatusBadge3').innerHTML = `<span class="dot"></span> ${escapeHtml(igTxt)}`;

      $('igUsername').textContent = state.profile?.instagram_username ? `@${state.profile.instagram_username.replace(/^@/,'')}` : '—';

      $('statContactsHelp').textContent = `Limit: ${plan.contacts_limit === -1 ? 'Unlimited' : plan.contacts_limit}`;
      $('statAutomationsHelp').textContent = `Limit: ${plan.automations_limit === -1 ? 'Unlimited' : plan.automations_limit}`;
    }

    async function ensureProfile(authUser){
      // Auto create user profile on first login
      // Uses anon key only; must be allowed by RLS: user can insert/select/update their own row.
      const uid = authUser.id;
      const email = authUser.email || null;
      const identity = (authUser.identities && authUser.identities[0]) ? authUser.identities[0] : null;
      const googleId = identity?.provider === 'google' ? (identity?.id || identity?.user_id || null) : (identity?.id || null);

      const name = authUser.user_metadata?.full_name || authUser.user_metadata?.name || null;
      const avatar_url = authUser.user_metadata?.avatar_url || authUser.user_metadata?.picture || null;

      const { data: existing, error: selErr } = await supabase
        .from('users')
        .select('*')
        .eq('id', uid)
        .maybeSingle();

      if(selErr) throw selErr;

      if(existing) return existing;

      const now = new Date().toISOString();
      const toInsert = {
        id: uid,
        email,
        name,
        avatar_url,
        google_id: googleId,
        instagram_connected: false,
        plan_type: 'free',
        plan_expiry: null,
        contacts_count: 0,
        automations_count: 0,
        is_admin: false,
        created_at: now,
        updated_at: now
      };

      const { data: ins, error: insErr } = await supabase
        .from('users')
        .insert(toInsert)
        .select('*')
        .single();

      if(insErr) throw insErr;
      return ins;
    }

    async function loadPlans(){
      const { data, error } = await supabase
        .from('plans')
        .select('*')
        .eq('is_active', true)
        .order('price', { ascending:true });
      if(error){
        // If plans table not ready yet, keep fallback
        console.warn('plans load error:', error);
        state.plans = [];
        return;
      }
      state.plans = data || [];
    }

    async function loadProfile(){
      const uid = state.authUser?.id;
      if(!uid) return;
      const { data, error } = await supabase.from('users').select('*').eq('id', uid).single();
      if(error) throw error;
      state.profile = data;
      state.isAdmin = !!data?.is_admin;
      $('navAdmin').style.display = state.isAdmin ? '' : 'none';
      setBadges();
    }

    function showLanding(){
      $('landing').style.display = 'block';
      $('shell').style.display = 'none';
    }
    function showShell(){
      $('landing').style.display = 'none';
      $('shell').style.display = 'block';
    }

    // ---------------------------
    // Plan limits enforcement
    // ---------------------------
    async function getCounts(){
      const uid = state.authUser?.id;
      if(!uid) return { contacts:0, automations:0, messages:0 };

      // count contacts
      const c1 = await supabase.from('contacts').select('id', { count:'exact', head:true }).eq('user_id', uid);
      if(c1.error) throw c1.error;

      // count automations
      const a1 = await supabase.from('automations').select('id', { count:'exact', head:true }).eq('user_id', uid);
      if(a1.error) throw a1.error;

      // count messages
      const m1 = await supabase.from('messages').select('id', { count:'exact', head:true }).eq('user_id', uid);
      if(m1.error) throw m1.error;

      return { contacts: c1.count || 0, automations: a1.count || 0, messages: m1.count || 0 };
    }

    function checkLimit(current, limit){
      if(limit === -1) return true;
      return current < limit;
    }

    function upgradeNudge(reason){
      toast('warn', 'Upgrade required', reason + ' Open Billing to upgrade.');
      setTimeout(() => location.hash = '#/billing', 250);
    }

    // ---------------------------
    // Dashboard
    // ---------------------------
    async function refreshDashboard(){
      try{
        showLoading(true);
        await loadProfile();
        const counts = await getCounts();
        $('statContacts').textContent = String(counts.contacts);
        $('statAutomations').textContent = String(counts.automations);
        $('statMessages').textContent = String(counts.messages);

        // Today's triggers: schema doesn’t store per-day triggers.
        // We show a best-effort number by summing triggered; not “today”.
        const { data: autos, error } = await supabase
          .from('automations')
          .select('stats')
          .eq('user_id', state.authUser.id);
        if(error) throw error;

        const sumTriggered = (autos || []).reduce((acc, r) => acc + (r?.stats?.triggered ? Number(r.stats.triggered) : 0), 0);
        $('statTodayTriggers').textContent = String(sumTriggered);
      }catch(e){
        toast('bad','Dashboard error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    // ---------------------------
    // Automations
    // ---------------------------
    function renderAutomationRow(a){
      const keywords = Array.isArray(a.trigger_keywords) ? a.trigger_keywords.join(', ') : '';
      const active = !!a.is_active;
      const toggCls = active ? 'toggle on' : 'toggle';
      const statusBadge = active ? `<span class="badge ok"><span class="dot"></span> Active</span>` : `<span class="badge warn"><span class="dot"></span> Off</span>`;
      const trig = a?.stats?.triggered ?? 0;
      const rep = a?.stats?.replied ?? 0;

      return `
        <tr>
          <td><strong>${escapeHtml(a.name || '')}</strong></td>
          <td>${escapeHtml(a.trigger_type || '')}</td>
          <td>${escapeHtml(keywords)}</td>
          <td>${statusBadge}</td>
          <td>${escapeHtml(trig)}</td>
          <td>${escapeHtml(rep)}</td>
          <td>
            <div class="rowActions">
              <span class="${toggCls}" data-action="toggle" data-id="${escapeHtml(a.id)}" role="switch" aria-checked="${active}"></span>
              <button class="btn sm" data-action="edit" data-id="${escapeHtml(a.id)}"><i class="fa-solid fa-pen"></i> Edit</button>
              <button class="btn sm danger" data-action="delete" data-id="${escapeHtml(a.id)}"><i class="fa-solid fa-trash"></i> Delete</button>
            </div>
          </td>
        </tr>
      `;
    }

    async function loadAutomations(){
      try{
        showLoading(true);
        const uid = state.authUser.id;
        const { data, error } = await supabase
          .from('automations')
          .select('*')
          .eq('user_id', uid)
          .order('created_at', { ascending:false });
        if(error) throw error;

        const tb = $('automationsTbody');
        if(!data || data.length === 0){
          tb.innerHTML = `<tr><td colspan="7">No automations yet. Click “Create automation”.</td></tr>`;
        }else{
          tb.innerHTML = data.map(renderAutomationRow).join('');
        }

        tb.onclick = async (ev) => {
          const t = ev.target.closest('[data-action], .toggle');
          if(!t) return;

          const id = t.dataset.id;
          const action = t.classList.contains('toggle') ? 'toggle' : t.dataset.action;

          if(action === 'toggle') return toggleAutomation(id);
          if(action === 'delete') return deleteAutomation(id);
          if(action === 'edit') return openEditAutomation(id);
        };
      }catch(e){
        toast('bad','Automations error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function canCreateAutomation(){
      const { automations } = await getCounts();
      const limit = state.limits.automations_limit;
      if(checkLimit(automations, limit)) return true;
      upgradeNudge(`You reached your automations limit (${limit}).`);
      return false;
    }

    function openCreateAutomationModal(){
      openModal(
        'Create Automation',
        `
          <div class="formGrid">
            <div>
              <label>Name</label>
              <input id="aName" placeholder="e.g. Welcome DM" />
            </div>
            <div>
              <label>Trigger type</label>
              <select id="aTrigger">
                <option value="keyword_dm">keyword_dm</option>
                <option value="keyword_comment">keyword_comment</option>
                <option value="story_mention">story_mention</option>
                <option value="first_message">first_message</option>
              </select>
            </div>
            <div>
              <label>Trigger keywords (comma separated)</label>
              <input id="aKeywords" placeholder="e.g. price, help, demo" />
              <div class="help">For types like story_mention/first_message you can keep this empty.</div>
            </div>
            <div>
              <label>Response message</label>
              <textarea id="aResponse" placeholder="Your auto reply..."></textarea>
            </div>
          </div>
        `,
        [
          button('Cancel','', 'xmark', () => closeModal()),
          button('Create','primary','plus', async () => {
            await createAutomationFromModal();
          })
        ]
      );
    }

    async function createAutomationFromModal(){
      try{
        showLoading(true);
        if(!(await canCreateAutomation())) return;

        const name = $('aName').value.trim();
        const trigger_type = $('aTrigger').value;
        const keywordsRaw = $('aKeywords').value.trim();
        const response_message = $('aResponse').value.trim();

        if(!name) throw new Error('Name is required.');
        if(!trigger_type) throw new Error('Trigger type is required.');
        if(!response_message) throw new Error('Response message is required.');

        const trigger_keywords = keywordsRaw
          ? keywordsRaw.split(',').map(s => s.trim()).filter(Boolean)
          : [];

        const payload = {
          user_id: state.authUser.id,
          name,
          trigger_type,
          trigger_keywords,
          response_message,
          is_active: true,
          stats: { triggered: 0, replied: 0 }
        };

        const { error } = await supabase.from('automations').insert(payload);
        if(error) throw error;

        toast('ok','Created','Automation created.');
        closeModal();
        await loadAutomations();
        await refreshDashboard();
      }catch(e){
        toast('bad','Create failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function toggleAutomation(id){
      try{
        showLoading(true);
        const { data, error } = await supabase.from('automations').select('is_active').eq('id', id).single();
        if(error) throw error;
        const next = !data.is_active;
        const { error: upErr } = await supabase.from('automations').update({ is_active: next }).eq('id', id);
        if(upErr) throw upErr;
        toast('ok','Updated', next ? 'Automation enabled.' : 'Automation disabled.');
        await loadAutomations();
      }catch(e){
        toast('bad','Toggle failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function deleteAutomation(id){
      try{
        openModal(
          'Delete automation',
          `<div style="color:var(--muted); line-height:1.55;">This will permanently delete the automation.</div>`,
          [
            button('Cancel','', 'xmark', closeModal),
            button('Delete','danger','trash', async () => {
              try{
                showLoading(true);
                const { error } = await supabase.from('automations').delete().eq('id', id);
                if(error) throw error;
                toast('ok','Deleted','Automation deleted.');
                closeModal();
                await loadAutomations();
                await refreshDashboard();
              }catch(e){
                toast('bad','Delete failed', e.message || String(e));
              }finally{
                showLoading(false);
              }
            })
          ]
        );
      }catch(e){
        toast('bad','Error', e.message || String(e));
      }
    }

    async function openEditAutomation(id){
      try{
        showLoading(true);
        const { data, error } = await supabase.from('automations').select('*').eq('id', id).single();
        if(error) throw error;

        openModal(
          'Edit Automation',
          `
            <div class="formGrid">
              <div>
                <label>Name</label>
                <input id="eaName" value="${escapeHtml(data.name || '')}" />
              </div>
              <div>
                <label>Trigger type</label>
                <select id="eaTrigger">
                  ${['keyword_dm','keyword_comment','story_mention','first_message'].map(v =>
                    `<option value="${v}" ${data.trigger_type===v?'selected':''}>${v}</option>`
                  ).join('')}
                </select>
              </div>
              <div>
                <label>Trigger keywords (comma separated)</label>
                <input id="eaKeywords" value="${escapeHtml((data.trigger_keywords||[]).join(', '))}" />
              </div>
              <div>
                <label>Response message</label>
                <textarea id="eaResponse">${escapeHtml(data.response_message || '')}</textarea>
              </div>
            </div>
          `,
          [
            button('Cancel','', 'xmark', closeModal),
            button('Save','primary','floppy-disk', async () => {
              await saveEditAutomation(id);
            })
          ]
        );
      }catch(e){
        toast('bad','Edit error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function saveEditAutomation(id){
      try{
        showLoading(true);
        const name = $('eaName').value.trim();
        const trigger_type = $('eaTrigger').value;
        const keywordsRaw = $('eaKeywords').value.trim();
        const response_message = $('eaResponse').value.trim();

        if(!name) throw new Error('Name is required.');
        if(!response_message) throw new Error('Response message is required.');

        const trigger_keywords = keywordsRaw
          ? keywordsRaw.split(',').map(s => s.trim()).filter(Boolean)
          : [];

        const { error } = await supabase
          .from('automations')
          .update({ name, trigger_type, trigger_keywords, response_message })
          .eq('id', id);

        if(error) throw error;

        toast('ok','Saved','Automation updated.');
        closeModal();
        await loadAutomations();
      }catch(e){
        toast('bad','Save failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    // ---------------------------
    // Contacts
    // ---------------------------
    async function canAddContact(){
      const { contacts } = await getCounts();
      const limit = state.limits.contacts_limit;
      if(checkLimit(contacts, limit)) return true;
      upgradeNudge(`You reached your contacts limit (${limit}).`);
      return false;
    }

    function openAddContactModal(){
      openModal(
        'Add Contact',
        `
          <div class="formGrid">
            <div>
              <label>Instagram username</label>
              <input id="cUsername" placeholder="e.g. john_doe" />
            </div>
            <div>
              <label>Instagram ID (optional)</label>
              <input id="cInstaId" placeholder="e.g. 1784..." />
            </div>
            <div>
              <label>Profile pic URL (optional)</label>
              <input id="cPic" placeholder="https://…" />
            </div>
            <div>
              <label>Tags (comma separated)</label>
              <input id="cTags" placeholder="lead, vip, buyer" />
            </div>
          </div>
        `,
        [
          button('Cancel','', 'xmark', closeModal),
          button('Add','primary','user-plus', async () => {
            await addContactFromModal();
          })
        ]
      );
    }

    async function addContactFromModal(){
      try{
        showLoading(true);
        if(!(await canAddContact())) return;

        const username = $('cUsername').value.trim().replace(/^@/,'');
        const instagram_id = $('cInstaId').value.trim() || null;
        const profile_pic = $('cPic').value.trim() || null;
        const tagsRaw = $('cTags').value.trim();
        const tags = tagsRaw ? tagsRaw.split(',').map(s => s.trim()).filter(Boolean) : [];

        if(!username) throw new Error('Username is required.');

        const payload = {
          user_id: state.authUser.id,
          instagram_id,
          username,
          profile_pic,
          tags,
          last_message_at: null
        };

        const { error } = await supabase.from('contacts').insert(payload);
        if(error) throw error;

        toast('ok','Added','Contact added.');
        closeModal();
        await loadContacts();
        await refreshDashboard();
      }catch(e){
        toast('bad','Add failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    function renderContactRow(c){
      const tags = Array.isArray(c.tags) ? c.tags : [];
      const tagsHtml = tags.length
        ? tags.map(t => `<span class="badge" style="margin-right:6px;"><span class="dot"></span> ${escapeHtml(t)}</span>`).join('')
        : '<span class="badge"><span class="dot"></span> —</span>';

      const pic = c.profile_pic || '';
      const picHtml = pic
        ? `<img class="avatar" style="width:34px;height:34px;border-radius:14px;" src="${escapeHtml(pic)}" alt="pic" />`
        : `<div class="iconBubble" style="width:34px;height:34px;"><i class="fa-solid fa-user"></i></div>`;

      return `
        <tr>
          <td>${picHtml}</td>
          <td><strong>@${escapeHtml(c.username || '')}</strong></td>
          <td>${tagsHtml}</td>
          <td>${escapeHtml(c.last_message_at ? fmtDate(c.last_message_at) : '—')}</td>
          <td>
            <div class="rowActions">
              <button class="btn sm danger" data-action="delete" data-id="${escapeHtml(c.id)}"><i class="fa-solid fa-trash"></i> Delete</button>
            </div>
          </td>
        </tr>
      `;
    }

    async function loadContacts(){
      try{
        showLoading(true);
        const uid = state.authUser.id;
        const { data, error } = await supabase
          .from('contacts')
          .select('*')
          .eq('user_id', uid)
          .order('created_at', { ascending:false });
        if(error) throw error;

        const tb = $('contactsTbody');
        if(!data || data.length === 0){
          tb.innerHTML = `<tr><td colspan="5">No contacts yet. Click “Add contact”.</td></tr>`;
        }else{
          tb.innerHTML = data.map(renderContactRow).join('');
        }

        tb.onclick = async (ev) => {
          const btn = ev.target.closest('[data-action="delete"]');
          if(!btn) return;
          const id = btn.dataset.id;
          await deleteContact(id);
        };
      }catch(e){
        toast('bad','Contacts error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function deleteContact(id){
      openModal(
        'Delete contact',
        `<div style="color:var(--muted); line-height:1.55;">This will remove the contact and related message links may break unless handled server-side.</div>`,
        [
          button('Cancel','', 'xmark', closeModal),
          button('Delete','danger','trash', async () => {
            try{
              showLoading(true);
              const { error } = await supabase.from('contacts').delete().eq('id', id);
              if(error) throw error;
              toast('ok','Deleted','Contact deleted.');
              closeModal();
              await loadContacts();
              await refreshDashboard();
            }catch(e){
              toast('bad','Delete failed', e.message || String(e));
            }finally{
              showLoading(false);
            }
          })
        ]
      );
    }

    // ---------------------------
    // Inbox
    // ---------------------------
    async function loadInbox(){
      try{
        showLoading(true);
        const uid = state.authUser.id;

        const { data, error } = await supabase
          .from('messages')
          .select('id, content, sender_type, is_automated, created_at, contact_id, contacts(username, profile_pic)')
          .eq('user_id', uid)
          .order('created_at', { ascending:false })
          .limit(20);

        if(error) throw error;

        const list = $('inboxList');
        if(!data || data.length === 0){
          list.innerHTML = `<div class="glass2 msgItem">No messages yet.</div>`;
          return;
        }

        list.innerHTML = data.map(m => {
          const uname = m.contacts?.username ? '@' + m.contacts.username : 'Unknown';
          const pic = m.contacts?.profile_pic || '';
          const when = fmtDate(m.created_at);
          const badge = m.is_automated ? `<span class="badge ok"><span class="dot"></span> automated</span>` : `<span class="badge"><span class="dot"></span> manual</span>`;
          return `
            <div class="glass2 msgItem">
              <img class="p" src="${escapeHtml(pic || 'data:image/svg+xml;utf8,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%2242%22 height=%2242%22><rect width=%2242%22 height=%2242%22 rx=%2216%22 fill=%22%23161a35%22/><text x=%2221%22 y=%2226%22 text-anchor=%22middle%22 fill=%22%23cfd3ff%22 font-size=%2216%22 font-family=%22Poppins%22>?</text></svg>')}" alt="pic"/>
              <div class="meta">
                <div class="top">
                  <div class="who">${escapeHtml(uname)} ${badge}</div>
                  <div class="when">${escapeHtml(when)}</div>
                </div>
                <div class="txt">${escapeHtml(m.content || '')}</div>
              </div>
            </div>
          `;
        }).join('');
      }catch(e){
        toast('bad','Inbox error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function composeSave(){
      try{
        showLoading(true);
        const uname = $('composeUsername').value.trim().replace(/^@/,'');
        const content = $('composeContent').value.trim();
        if(!uname) throw new Error('Contact username is required.');
        if(!content) throw new Error('Message is required.');

        const uid = state.authUser.id;
        const { data: contact, error: cErr } = await supabase
          .from('contacts')
          .select('id')
          .eq('user_id', uid)
          .eq('username', uname)
          .limit(1)
          .maybeSingle();

        if(cErr) throw cErr;
        if(!contact) throw new Error('Contact not found. Add the contact first.');

        const payload = {
          user_id: uid,
          contact_id: contact.id,
          content,
          sender_type: 'user',
          is_automated: false
        };

        const { error } = await supabase.from('messages').insert(payload);
        if(error) throw error;

        // update last_message_at
        await supabase.from('contacts').update({ last_message_at: new Date().toISOString() }).eq('id', contact.id);

        toast('ok','Saved','Message saved to inbox.');
        $('composeContent').value = '';
        await loadInbox();
        await refreshDashboard();
      }catch(e){
        toast('bad','Save failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    // ---------------------------
    // Analytics
    // ---------------------------
    async function loadAnalytics(){
      try{
        showLoading(true);
        await loadProfile();
        const ptype = (state.profile?.plan_type || 'free').toLowerCase();
        const access = ptype === 'free' ? 'limited' : 'full';
        $('analyticsAccess').className = `badge ${access === 'full' ? 'ok' : 'warn'}`;
        $('analyticsAccess').innerHTML = `<span class="dot"></span> ${escapeHtml(access)}`;

        const main = $('analyticsMain');
        main.classList.remove('lock');

        const uid = state.authUser.id;

        // Basic aggregation always allowed for the user's own rows
        const { data: autos, error: aErr } = await supabase
          .from('automations')
          .select('stats')
          .eq('user_id', uid);
        if(aErr) throw aErr;

        const triggered = (autos || []).reduce((acc,r) => acc + (Number(r?.stats?.triggered || 0)), 0);
        const replied = (autos || []).reduce((acc,r) => acc + (Number(r?.stats?.replied || 0)), 0);
        $('anaTriggered').textContent = String(triggered);
        $('anaReplied').textContent = String(replied);

        const { data: msgs, error: mErr } = await supabase
          .from('messages')
          .select('is_automated')
          .eq('user_id', uid)
          .limit(2000);
        if(mErr) throw mErr;

        const auto = (msgs || []).filter(x => x.is_automated).length;
        const manual = (msgs || []).length - auto;
        $('anaAuto').textContent = String(auto);
        $('anaManual').textContent = String(manual);

        if(access !== 'full'){
          // Lock visuals but keep a tiny peek (already filled)
          main.classList.add('lock');
        }
      }catch(e){
        toast('bad','Analytics error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    // ---------------------------
    // Settings
    // ---------------------------
    function fillSettings(){
      $('setName').value = state.profile?.name || '';
      $('setAvatarUrl').value = state.profile?.avatar_url || '';
      $('igUser').value = state.profile?.instagram_username || '';
      $('igToken').value = state.profile?.instagram_token || '';
      setBadges();
    }

    async function saveProfile(){
      try{
        showLoading(true);
        const name = $('setName').value.trim() || null;
        const avatar_url = $('setAvatarUrl').value.trim() || null;

        const { error } = await supabase
          .from('users')
          .update({ name, avatar_url, updated_at: new Date().toISOString() })
          .eq('id', state.authUser.id);

        if(error) throw error;

        toast('ok','Saved','Profile updated.');
        await loadProfile();
        $('userName').textContent = state.profile?.name || '—';
        $('userAvatar').src = state.profile?.avatar_url || '';
      }catch(e){
        toast('bad','Save failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function saveInstagram(){
      try{
        showLoading(true);
        const instagram_username = $('igUser').value.trim().replace(/^@/,'') || null;
        const instagram_token = $('igToken').value.trim() || null;
        const instagram_connected = !!(instagram_username && instagram_token);

        const { error } = await supabase
          .from('users')
          .update({
            instagram_username,
            instagram_token,
            instagram_connected,
            updated_at: new Date().toISOString()
          })
          .eq('id', state.authUser.id);

        if(error) throw error;

        toast('ok','Saved','Instagram connection updated.');
        await loadProfile();
        fillSettings();
      }catch(e){
        toast('bad','Save failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function disconnectInstagram(){
      try{
        showLoading(true);
        const { error } = await supabase
          .from('users')
          .update({
            instagram_username: null,
            instagram_token: null,
            instagram_connected: false,
            updated_at: new Date().toISOString()
          })
          .eq('id', state.authUser.id);

        if(error) throw error;

        toast('ok','Disconnected','Instagram disconnected.');
        await loadProfile();
        fillSettings();
      }catch(e){
        toast('bad','Disconnect failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    // ---------------------------
    // Billing (PhonePe UPI manual)
    // ---------------------------
    function makeTxnId(){
      // simple unique client-generated transaction id
      return 'TXN_' + Date.now() + '_' + Math.random().toString(16).slice(2);
    }

    function makeUpiUrl({ upiId, payeeName, amount, note, txnId }){
      const p = new URLSearchParams({
        pa: upiId,
        pn: payeeName,
        am: String(amount),
        tn: note,
        tr: txnId
      });
      return `upi://pay?${p.toString()}`;
    }

    async function loadBilling(){
      try{
        showLoading(true);
        await loadProfile();
        const ptype = (state.profile?.plan_type || 'free').toLowerCase();
        $('curPlan').textContent = ptype;
        $('curExpiry').textContent = state.profile?.plan_expiry ? fmtDate(state.profile.plan_expiry) : '—';
        setBadges();

        const uid = state.authUser.id;
        const { data, error } = await supabase
          .from('subscriptions')
          .select('*')
          .eq('user_id', uid)
          .order('created_at', { ascending:false })
          .limit(20);
        if(error) throw error;

        const tb = $('subsTbody');
        if(!data || data.length === 0){
          tb.innerHTML = `<tr><td colspan="5">No payments yet.</td></tr>`;
          return;
        }
        tb.innerHTML = data.map(s => {
          const st = String(s.payment_status || 'pending').toLowerCase();
          const cls = st === 'success' ? 'ok' : (st.includes('fail') ? 'bad' : 'warn');
          return `
            <tr>
              <td><strong>${escapeHtml(s.plan_type || '')}</strong></td>
              <td>₹${escapeHtml(s.amount || 0)}</td>
              <td>${escapeHtml(s.transaction_id || '—')}</td>
              <td><span class="badge ${cls}"><span class="dot"></span> ${escapeHtml(st)}</span></td>
              <td>${escapeHtml(fmtDate(s.created_at))}</td>
            </tr>
          `;
        }).join('');
      }catch(e){
        toast('bad','Billing error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function startUpgrade(planType){
      try{
        showLoading(true);
        await loadPlans();
        const plan = planMeta(planType);
        const amount = Number(plan.price || 0);
        if(!amount) throw new Error('Invalid plan amount.');

        const txnId = makeTxnId();
        const note = `InstaBot Pro ${planType} subscription`;

        // create subscription row (pending)
        const subPayload = {
          user_id: state.authUser.id,
          plan_type: planType,
          amount: amount,
          transaction_id: txnId,
          payment_status: 'pending',
          payment_method: 'phonepe',
          expires_at: null
        };

        const { data: created, error } = await supabase
          .from('subscriptions')
          .insert(subPayload)
          .select('*')
          .single();

        if(error) throw error;

        const upiUrl = makeUpiUrl({
          upiId: UPI_ID,
          payeeName: UPI_PAYEE_NAME,
          amount,
          note: `${note} (${txnId})`,
          txnId
        });

        // Heuristic: mobile opens UPI apps
        const isMobile = /Android|iPhone|iPad|iPod/i.test(navigator.userAgent);

        openModal(
          `Pay with UPI (PhonePe)`,
          `
            <div class="formGrid">
              <div class="glass2" style="padding:12px;">
                <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
                  <div>
                    <div style="font-weight:900;">Plan: ${escapeHtml(planType)}</div>
                    <div style="color:var(--muted); font-size:12px;">Amount: ₹${escapeHtml(amount)} • Transaction: ${escapeHtml(txnId)}</div>
                  </div>
                  <span class="badge warn"><span class="dot"></span> pending</span>
                </div>
              </div>

              <div>
                <label>UPI intent URL</label>
                <input value="${escapeHtml(upiUrl)}" readonly />
                <div class="help">
                  Mobile: open directly. Desktop: copy this or pay manually to <strong>${escapeHtml(UPI_ID)}</strong> with note <strong>${escapeHtml(txnId)}</strong>.
                </div>
              </div>

              <div class="glass2" style="padding:12px;">
                <div style="font-weight:800; font-size:13px;">Manual verification</div>
                <div style="color:var(--muted); font-size:12px; margin-top:6px; line-height:1.55;">
                  After payment, click “I have paid”. Admin will verify and mark success, then your plan/expiry updates.
                </div>
              </div>
            </div>
          `,
          [
            button('Close','', 'xmark', async () => { closeModal(); await loadBilling(); }),
            button('Copy link','', 'copy', async () => {
              try{
                await navigator.clipboard.writeText(upiUrl);
                toast('ok','Copied','UPI link copied.');
              }catch{
                toast('warn','Copy failed','Please copy manually.');
              }
            }),
            button(isMobile ? 'Open UPI app' : 'I have paid','primary','credit-card', async () => {
              if(isMobile){
                // open UPI intent
                window.location.href = upiUrl;
              }else{
                // mark as pending_verification (still requires admin to mark success)
                const { error: upErr } = await supabase
                  .from('subscriptions')
                  .update({ payment_status: 'pending_verification' })
                  .eq('id', created.id);
                if(upErr) toast('bad','Update failed', upErr.message);
                else toast('ok','Submitted','Payment submitted for verification.');
                closeModal();
                await loadBilling();
              }
            })
          ]
        );
      }catch(e){
        toast('bad','Upgrade error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    // ---------------------------
    // Admin
    // ---------------------------
    async function loadAdmin(){
      try{
        showLoading(true);
        await loadProfile();
        if(!state.isAdmin){
          toast('warn','Not allowed','Admin access required.');
          location.hash = '#/dashboard';
          return;
        }

        await loadPlans();

        // Total users
        const usersCount = await supabase.from('users').select('id', { count:'exact', head:true });
        if(usersCount.error) throw usersCount.error;
        $('admTotalUsers').textContent = String(usersCount.count || 0);

        // Pro users / Master users
        const proCount = await supabase.from('users').select('id', { count:'exact', head:true }).eq('plan_type','pro');
        if(proCount.error) throw proCount.error;
        $('admProUsers').textContent = String(proCount.count || 0);

        const masterCount = await supabase.from('users').select('id', { count:'exact', head:true }).eq('plan_type','master');
        if(masterCount.error) throw masterCount.error;
        $('admMasterUsers').textContent = String(masterCount.count || 0);

        // Revenue from successful subscriptions
        const { data: subs, error: sErr } = await supabase
          .from('subscriptions')
          .select('amount, payment_status')
          .in('payment_status', ['success']);
        if(sErr) throw sErr;
        const revenue = (subs || []).reduce((acc,x) => acc + Number(x.amount || 0), 0);
        $('admRevenue').textContent = '₹' + revenue;

        // plans table
        const plansT = $('plansTbody');
        if(state.plans.length === 0){
          plansT.innerHTML = `<tr><td colspan="5">No plans found (check plans table & RLS).</td></tr>`;
        }else{
          plansT.innerHTML = state.plans.map(p => `
            <tr>
              <td><strong>${escapeHtml(p.name)}</strong></td>
              <td>₹${escapeHtml(p.price)}</td>
              <td>${escapeHtml(p.contacts_limit)}</td>
              <td>${escapeHtml(p.automations_limit)}</td>
              <td>${escapeHtml(p.team_members_limit)}</td>
            </tr>
          `).join('');
        }

        // users list
        const { data: users, error: uErr } = await supabase
          .from('users')
          .select('id, email, name, plan_type, plan_expiry, is_admin')
          .order('created_at', { ascending:false })
          .limit(50);
        if(uErr) throw uErr;

        $('usersTbody').innerHTML = (users || []).map(u => `
          <tr>
            <td><strong>${escapeHtml(u.name || '—')}</strong><div style="color:var(--muted2); font-size:12px;">${escapeHtml(u.email || '')}</div></td>
            <td>${escapeHtml(u.plan_type || 'free')}</td>
            <td>${escapeHtml(u.plan_expiry ? fmtDate(u.plan_expiry) : '—')}</td>
            <td>${u.is_admin ? '<span class="badge ok"><span class="dot"></span> yes</span>' : '<span class="badge"><span class="dot"></span> no</span>'}</td>
            <td>
              <div class="rowActions">
                <button class="btn sm" data-action="setplan" data-id="${escapeHtml(u.id)}"><i class="fa-solid fa-wrench"></i> Set Plan</button>
              </div>
            </td>
          </tr>
        `).join('') || `<tr><td colspan="5">No users.</td></tr>`;

        $('usersTbody').onclick = async (ev) => {
          const btn = ev.target.closest('[data-action="setplan"]');
          if(!btn) return;
          openSetUserPlan(btn.dataset.id);
        };

        // pending subscriptions
        const { data: pend, error: pErr } = await supabase
          .from('subscriptions')
          .select('id, user_id, plan_type, amount, transaction_id, payment_status, created_at, users(email, name)')
          .in('payment_status', ['pending', 'pending_verification'])
          .order('created_at', { ascending:false })
          .limit(50);
        if(pErr) throw pErr;

        $('pendingSubsTbody').innerHTML = (pend || []).map(x => {
          const st = String(x.payment_status || 'pending').toLowerCase();
          const cls = 'warn';
          return `
            <tr>
              <td><strong>${escapeHtml(x.users?.name || '—')}</strong><div style="color:var(--muted2); font-size:12px;">${escapeHtml(x.users?.email || '')}</div></td>
              <td>${escapeHtml(x.plan_type || '')}</td>
              <td>₹${escapeHtml(x.amount || 0)}</td>
              <td>${escapeHtml(x.transaction_id || '—')}</td>
              <td><span class="badge ${cls}"><span class="dot"></span> ${escapeHtml(st)}</span></td>
              <td>${escapeHtml(fmtDate(x.created_at))}</td>
              <td>
                <div class="rowActions">
                  <button class="btn sm ok" data-action="verify" data-id="${escapeHtml(x.id)}"><i class="fa-solid fa-check"></i> Mark success</button>
                  <button class="btn sm danger" data-action="fail" data-id="${escapeHtml(x.id)}"><i class="fa-solid fa-xmark"></i> Mark failed</button>
                </div>
              </td>
            </tr>
          `;
        }).join('') || `<tr><td colspan="7">No pending subscriptions.</td></tr>`;

        $('pendingSubsTbody').onclick = async (ev) => {
          const b = ev.target.closest('[data-action]');
          if(!b) return;
          const id = b.dataset.id;
          const action = b.dataset.action;
          if(action === 'verify') return adminMarkSubscriptionSuccess(id);
          if(action === 'fail') return adminMarkSubscriptionFailed(id);
        };

      }catch(e){
        toast('bad','Admin error', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    function openEditPlanModal(){
      if(!state.isAdmin){
        toast('warn','Not allowed','Admin access required.');
        return;
      }
      const options = state.plans.map(p => `<option value="${escapeHtml(p.id)}">${escapeHtml(p.name)}</option>`).join('');
      openModal(
        'Edit Plan',
        `
          <div class="formGrid">
            <div>
              <label>Select plan</label>
              <select id="epId">${options}</select>
            </div>
            <div class="glass2" style="padding:12px; color:var(--muted); font-size:12px; line-height:1.55;">
              Admin edits run via Supabase RLS (no service role key in source).
              Make sure your RLS allows <code>is_admin=true</code> users to update plans.
            </div>
            <div>
              <label>Price (integer)</label>
              <input id="epPrice" type="number" />
            </div>
            <div>
              <label>Contacts limit (-1 for unlimited)</label>
              <input id="epContacts" type="number" />
            </div>
            <div>
              <label>Automations limit (-1 for unlimited)</label>
              <input id="epAutos" type="number" />
            </div>
            <div>
              <label>Team members limit (-1 for unlimited)</label>
              <input id="epTeam" type="number" />
            </div>
          </div>
        `,
        [
          button('Cancel','', 'xmark', closeModal),
          button('Load','', 'download', () => {
            const pid = $('epId').value;
            const p = state.plans.find(x => String(x.id) === String(pid));
            if(!p) return;
            $('epPrice').value = p.price ?? 0;
            $('epContacts').value = p.contacts_limit ?? 0;
            $('epAutos').value = p.automations_limit ?? 0;
            $('epTeam').value = p.team_members_limit ?? 0;
          }),
          button('Save','primary','floppy-disk', async () => {
            await adminSavePlanEdits();
          })
        ]
      );

      // auto-load first
      setTimeout(() => {
        const pid = $('epId').value;
        const p = state.plans.find(x => String(x.id) === String(pid));
        if(p){
          $('epPrice').value = p.price ?? 0;
          $('epContacts').value = p.contacts_limit ?? 0;
          $('epAutos').value = p.automations_limit ?? 0;
          $('epTeam').value = p.team_members_limit ?? 0;
        }
      }, 0);
    }

    async function adminSavePlanEdits(){
      try{
        showLoading(true);
        const id = $('epId').value;
        const price = Number($('epPrice').value);
        const contacts_limit = Number($('epContacts').value);
        const automations_limit = Number($('epAutos').value);
        const team_members_limit = Number($('epTeam').value);

        const { error } = await supabase
          .from('plans')
          .update({ price, contacts_limit, automations_limit, team_members_limit })
          .eq('id', id);

        if(error) throw error;

        toast('ok','Saved','Plan updated.');
        closeModal();
        await loadAdmin();
      }catch(e){
        toast('bad','Save failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    function openSetUserPlan(userId){
      const options = ['free','pro','master'].map(p => `<option value="${p}">${p}</option>`).join('');
      openModal(
        'Set User Plan',
        `
          <div class="formGrid">
            <div>
              <label>User ID</label>
              <input value="${escapeHtml(userId)}" readonly />
            </div>
            <div>
              <label>Plan</label>
              <select id="supPlan">${options}</select>
            </div>
            <div>
              <label>Expiry (days from now)</label>
              <input id="supDays" type="number" value="30" />
              <div class="help">For free plan you can set 0 to clear expiry.</div>
            </div>
          </div>
        `,
        [
          button('Cancel','', 'xmark', closeModal),
          button('Apply','primary','check', async () => {
            await adminSetUserPlan(userId);
          })
        ]
      );
    }

    async function adminSetUserPlan(userId){
      try{
        showLoading(true);
        const plan_type = $('supPlan').value;
        const days = Number($('supDays').value || 0);

        let plan_expiry = null;
        if(days > 0){
          const d = new Date();
          d.setDate(d.getDate() + days);
          plan_expiry = d.toISOString();
        }

        const { error } = await supabase
          .from('users')
          .update({ plan_type, plan_expiry, updated_at: new Date().toISOString() })
          .eq('id', userId);

        if(error) throw error;

        toast('ok','Updated','User plan updated.');
        closeModal();
        await loadAdmin();
      }catch(e){
        toast('bad','Update failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function adminMarkSubscriptionSuccess(subId){
      try{
        showLoading(true);

        const { data: sub, error: sErr } = await supabase
          .from('subscriptions')
          .select('*')
          .eq('id', subId)
          .single();
        if(sErr) throw sErr;

        // mark subscription success + set expires_at
        const expires = new Date();
        expires.setDate(expires.getDate() + 30); // monthly
        const expires_at = expires.toISOString();

        const { error: up1 } = await supabase
          .from('subscriptions')
          .update({ payment_status: 'success', expires_at })
          .eq('id', subId);
        if(up1) throw up1;

        // update user plan + expiry
        const { error: up2 } = await supabase
          .from('users')
          .update({ plan_type: sub.plan_type, plan_expiry: expires_at, updated_at: new Date().toISOString() })
          .eq('id', sub.user_id);
        if(up2) throw up2;

        toast('ok','Verified','Subscription marked success and user plan updated.');
        await loadAdmin();
      }catch(e){
        toast('bad','Verify failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    async function adminMarkSubscriptionFailed(subId){
      try{
        showLoading(true);
        const { error } = await supabase
          .from('subscriptions')
          .update({ payment_status: 'failed' })
          .eq('id', subId);
        if(error) throw error;

        toast('ok','Updated','Subscription marked failed.');
        await loadAdmin();
      }catch(e){
        toast('bad','Update failed', e.message || String(e));
      }finally{
        showLoading(false);
      }
    }

    // ---------------------------
    // Realtime (optional UI refresh)
    // ---------------------------
    function setupRealtime(){
      const uid = state.authUser?.id;
      if(!uid) return;

      supabase.channel('rt_user_data')
        .on('postgres_changes', { event:'*', schema:'public', table:'automations', filter:`user_id=eq.${uid}` }, () => {
          if(state.route === 'automations' || state.route === 'dashboard' || state.route === 'analytics'){
            loadAutomations();
            refreshDashboard();
            loadAnalytics();
          }
        })
        .on('postgres_changes', { event:'*', schema:'public', table:'contacts', filter:`user_id=eq.${uid}` }, () => {
          if(state.route === 'contacts' || state.route === 'dashboard'){
            loadContacts();
            refreshDashboard();
          }
        })
        .on('postgres_changes', { event:'*', schema:'public', table:'messages', filter:`user_id=eq.${uid}` }, () => {
          if(state.route === 'inbox' || state.route === 'dashboard' || state.route === 'analytics'){
            loadInbox();
            refreshDashboard();
            loadAnalytics();
          }
        })
        .subscribe();
    }

    // ---------------------------
    // UI wiring
    // ---------------------------
    function wireUI(){
      // Landing login buttons
      $('btnLoginGoogle').onclick = signInGoogle;
      $('btnHeroLogin').onclick = signInGoogle;
      $('btnPricingLogin').onclick = signInGoogle;
      $('btnGetStartedFree').onclick = signInGoogle;
      $('btnChoosePro').onclick = signInGoogle;
      $('btnChooseMaster').onclick = signInGoogle;

      // Sidebar toggles
      $('btnHamb').onclick = () => {
        const open = $('sidebar').classList.contains('open');
        open ? closeSidebar() : openSidebar();
      };

      // Logout
      $('btnLogout').onclick = logout;

      // Modal close
      $('btnCloseModal').onclick = closeModal;
      $('modalOverlay').onclick = (e) => { if(e.target === $('modalOverlay')) closeModal(); };
      window.addEventListener('keydown', (e) => { if(e.key === 'Escape') closeModal(); });

      // Quick actions
      $('btnOpenCreateAutomation').onclick = async () => { if(await canCreateAutomation()) openCreateAutomationModal(); };
      $('btnOpenAddContact').onclick = async () => { if(await canAddContact()) openAddContactModal(); };

      // Automations
      $('btnCreateAutomation').onclick = async () => { if(await canCreateAutomation()) openCreateAutomationModal(); };
      $('btnRefreshAutomations').onclick = loadAutomations;

      // Contacts
      $('btnAddContact').onclick = async () => { if(await canAddContact()) openAddContactModal(); };
      $('btnRefreshContacts').onclick = loadContacts;

      // Inbox
      $('btnRefreshInbox').onclick = loadInbox;
      $('btnComposeSave').onclick = composeSave;

      // Settings
      $('btnSaveProfile').onclick = saveProfile;
      $('btnSaveIg').onclick = saveInstagram;
      $('btnDisconnectIg').onclick = disconnectInstagram;

      // Billing
      $('btnUpgradePro').onclick = () => startUpgrade('pro');
      $('btnUpgradeMaster').onclick = () => startUpgrade('master');
      $('btnRefreshBilling').onclick = loadBilling;

      // Upgrade buttons
      $('btnQuickUpgrade').onclick = () => location.hash = '#/billing';
      $('btnAnaUpgrade').onclick = () => location.hash = '#/billing';

      // Admin
      $('btnRefreshAdmin').onclick = loadAdmin;
      $('btnOpenEditPlan').onclick = openEditPlanModal;
    }

    // ---------------------------
    // Boot
    // ---------------------------
    function initParticles(){
      if(!window.particlesJS) return;
      window.particlesJS('particles-js', {
        particles: {
          number: { value: 64, density: { enable: true, value_area: 900 } },
          color: { value: ["#6366f1", "#ec4899", "#ffffff"] },
          shape: { type: "circle" },
          opacity: { value: 0.22, random: true },
          size: { value: 3.2, random: true },
          line_linked: { enable: true, distance: 150, color: "#7c3aed", opacity: 0.18, width: 1 },
          move: { enable: true, speed: 1.15, direction: "none", random: true, straight: false, out_mode: "out" }
        },
        interactivity: {
          detect_on: "canvas",
          events: { onhover: { enable: true, mode: "repulse" }, onclick: { enable: true, mode: "push" }, resize: true },
          modes: { repulse: { distance: 120, duration: 0.3 }, push: { particles_nb: 2 } }
        },
        retina_detect: true
      });
    }

    async function onSignedIn(){
      try{
        showLoading(true);
        await loadPlans();
        state.profile = await ensureProfile(state.authUser);
        await loadProfile();

        // Fill sidebar user
        $('userName').textContent = state.profile?.name || state.authUser.user_metadata?.full_name || '—';
        $('userEmail').textContent = state.profile?.email || state.authUser.email || '—';
        $('userAvatar').src = state.profile?.avatar_url || state.authUser.user_metadata?.avatar_url || state.authUser.user_metadata?.picture || '';

        showShell();
        setupRealtime();

        const route = getRouteFromHash();
        if(route === 'admin' && !state.isAdmin) location.hash = '#/dashboard';
        setPage(getRouteFromHash());
      }catch(e){
        toast('bad','Init error', e.message || String(e));
        // If profile creation fails due to RLS, user needs backend policies fixed.
      }finally{
        showLoading(false);
      }
    }

    async function onSignedOut(){
      state.session = null;
      state.authUser = null;
      state.profile = null;
      state.isAdmin = false;
      showLanding();
    }

    async function boot(){
      wireUI();
      initParticles();

      window.addEventListener('hashchange', () => {
        if(!$('shell').style.display || $('shell').style.display === 'none') return;
        setPage(getRouteFromHash());
      });

      // Initial session
      const { data, error } = await supabase.auth.getSession();
      if(error) toast('bad','Auth error', error.message);

      state.session = data?.session || null;
      state.authUser = data?.session?.user || null;

      if(state.authUser) await onSignedIn();
      else await onSignedOut();

      // Listen auth changes
      supabase.auth.onAuthStateChange(async (event, session) => {
        state.session = session;
        state.authUser = session?.user || null;
        if(state.authUser) await onSignedIn();
        else await onSignedOut();
      });
    }

    // Global click to close sidebar when clicking outside (mobile)
    document.addEventListener('click', (e) => {
      const sb = $('sidebar');
      if(!sb.classList.contains('open')) return;
      const isHamb = e.target.closest('#btnHamb');
      const inside = e.target.closest('#sidebar');
      if(!inside && !isHamb) closeSidebar();
    });

    // Start
    boot();
  </script>

  <!--
    IMPORTANT SECURITY NOTE (frontend-only):
    - This file intentionally does NOT include any Supabase service role key.
    - Admin capabilities here depend entirely on Supabase RLS policies that check users.is_admin=true.
    - PhonePe verification is manual in this UI. For real production, do server-side PhonePe integration + webhook verification.
  -->
</body>
</html>
```
