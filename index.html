<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ChatFlow - ManyChat Clone (Automation Platform)</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">
    <style>
        :root {
            --primary: #007aff;
            --primary-dark: #0056b3;
            --bg-dark: #090e1a;
            --card-dark: #161c2d;
            --text-main: #ffffff;
            --text-dim: #94a3b8;
            --accent: #10b981;
            --danger: #ff4d4d;
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Outfit', sans-serif;
        }

        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Animated Glow Background */
        .glow-bg {
            position: fixed;
            width: 100vw;
            height: 100vh;
            z-index: -1;
            background: radial-gradient(circle at 50% 50%, #1e293b 0%, #090e1a 100%);
            overflow: hidden;
        }

        .glow-circle {
            position: absolute;
            width: 400px;
            height: 400px;
            background: var(--primary);
            filter: blur(150px);
            opacity: 0.15;
            border-radius: 50%;
            animation: float 10s infinite alternate;
        }

        @keyframes float {
            0% {
                transform: translate(0, 0);
            }

            100% {
                transform: translate(100px, 100px);
            }
        }

        /* Layout */
        .app-container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 260px;
            background: var(--card-dark);
            border-right: 1px solid var(--glass-border);
            padding: 24px;
            display: flex;
            flex-direction: column;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            position: relative;
        }

        /* Navigation */
        .logo {
            font-size: 24px;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 40px;
        }

        .nav-item {
            padding: 12px 16px;
            border-radius: 12px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: 0.3s;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover,
        .nav-item.active {
            background: var(--glass);
            color: var(--text-main);
        }

        /* Dashboard Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 24px;
            margin-bottom: 40px;
        }

        .stat-card {
            background: var(--card-dark);
            padding: 24px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
        }

        .stat-card::after {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 4px;
            height: 100%;
            background: var(--primary);
        }

        .stat-val {
            font-size: 32px;
            font-weight: 700;
            margin: 8px 0;
        }

        .stat-label {
            color: var(--text-dim);
            font-size: 14px;
        }

        /* Flow Builder Canvas */
        .builder-canvas {
            width: 100%;
            height: 600px;
            background: #0c1220;
            background-image: radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
            background-size: 30px 30px;
            border-radius: 24px;
            border: 1px solid var(--glass-border);
            position: relative;
            overflow: hidden;
            cursor: crosshair;
        }

        .node {
            position: absolute;
            width: 200px;
            background: #1e293b;
            border: 1px solid var(--primary);
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            cursor: move;
        }

        .node-header {
            font-weight: 600;
            font-size: 12px;
            color: var(--primary);
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .node-content {
            font-size: 14px;
            color: var(--text-main);
        }

        /* Auth Screen */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-dark);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .auth-card {
            background: var(--card-dark);
            padding: 48px;
            border-radius: 32px;
            text-align: center;
            width: 450px;
            border: 1px solid var(--glass-border);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
        }

        .google-btn {
            background: white;
            color: black;
            padding: 16px;
            border-radius: 12px;
            width: 100%;
            font-weight: 600;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-top: 32px;
        }

        /* Common Components */
        .btn {
            padding: 12px 24px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
            border: none;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-dim);
            border: 1px solid var(--glass-border);
        }

        .hidden {
            display: none !important;
        }

        /* Modals */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            z-index: 2000;
            display: none;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: var(--card-dark);
            border-radius: 24px;
            padding: 40px;
            width: 90%;
            max-width: 500px;
            border: 1px solid var(--glass-border);
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 14px;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            color: white;
            margin-bottom: 20px;
            outline: none;
        }

        /* Admin Section Style */
        .admin-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
        }

        .admin-table th {
            color: var(--text-dim);
            text-align: left;
            padding: 12px;
            border-bottom: 1px solid var(--glass-border);
        }

        .admin-table td {
            padding: 16px 12px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.03);
        }

        .badge {
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-pro {
            background: rgba(0, 122, 255, 0.2);
            color: var(--primary);
        }

        .badge-free {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-dim);
        }
    </style>
</head>

<body>
    <div class="glow-bg">
        <div class="glow-circle" style="top: 10%; left: 10%;"></div>
        <div class="glow-circle" style="bottom: 10%; right: 10%; background: #8b5cf6;"></div>
    </div>

    <!-- Auth Section -->
    <div id="authSection" class="auth-overlay">
        <div class="auth-card">
            <h1 style="font-size: 32px; margin-bottom: 12px;">ChatFlow</h1>
            <p style="color: var(--text-dim);">Automate your Instagram, Facebook & WhatsApp interactions in minutes.</p>
            <button class="google-btn" onclick="signIn()">
                <img src="https://www.google.com/favicon.ico" width="20">
                Continue with Google
            </button>
        </div>
    </div>

    <div id="appUI" class="app-container hidden">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo">ChatFlow</div>
            <div class="nav-item active" onclick="switchTab('dash')">üìä Dashboard</div>
            <div class="nav-item" onclick="switchTab('flows')">‚ö° Automations</div>
            <div class="nav-item" onclick="switchTab('audience')">üë• Audience</div>
            <div id="adminNavItem" class="nav-item hidden" onclick="switchTab('admin')">üîê God Mode</div>

            <div style="margin-top: auto;">
                <div class="nav-item" onclick="openBilling()">üíé Pricing & Upgrade</div>
                <div class="nav-item" onclick="signOut()" style="color: var(--danger);">üö™ Logout</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Tab -->
            <div id="tab-dash">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:40px;">
                    <h1>Welcome back, <span id="userName">User</span>!</h1>
                    <div id="subBadge" class="badge">FREE PLAN</div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Active Flows</div>
                        <div id="cntFlows" class="stat-val">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Messages Sent</div>
                        <div class="stat-val">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Total Contacts</div>
                        <div class="stat-val">0</div>
                    </div>
                </div>

                <h2>Recent Automations</h2>
                <div id="flowListDashboard" style="margin-top: 24px;"></div>
            </div>

            <!-- Flow Builder Tab -->
            <div id="tab-flows" class="hidden">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:32px;">
                    <h1>Automations</h1>
                    <button class="btn btn-primary" onclick="openNewFlowModal()">+ Create New Flow</button>
                </div>

                <div id="flowList" class="stats-grid"></div>
            </div>

            <!-- God Mode Tab -->
            <div id="tab-admin" class="hidden">
                <h1 style="color: var(--warning); margin-bottom: 12px;">God Mode Admin Control</h1>
                <p style="color: var(--text-dim);">Total authority over users, subscriptions, and payments.</p>

                <div style="margin-top: 40px;">
                    <h2>Pending UPI Approvals</h2>
                    <div id="adminPayments" style="margin-top: 20px;"></div>
                </div>

                <div style="margin-top: 40px;">
                    <h2>User Management</h2>
                    <div id="adminUsers" style="overflow-x: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="modalNewFlow" class="modal">
        <div class="modal-content">
            <h2>Create New Flow</h2>
            <p style="color: var(--text-dim); margin-bottom: 20px;">Give your automation a name.</p>
            <input type="text" id="flowTitleInput" placeholder="e.g. Instagram DM Auto-Reply">
            <div style="display:flex; gap:12px;">
                <button class="btn btn-primary" style="flex:1" onclick="createNewFlow()">Create</button>
                <button class="btn btn-ghost" onclick="closeModals()">Cancel</button>
            </div>
        </div>
    </div>

    <div id="modalBilling" class="modal">
        <div class="modal-content">
            <h2>Upgrade Account</h2>
            <div style="margin: 20px 0; background: var(--glass); padding: 20px; border-radius: 16px;">
                <label>Select Plan</label>
                <select id="payPlan">
                    <option value="pro">PRO PLAN - ‚Çπ999/month</option>
                    <option value="unlimited">ULTIMATE - ‚Çπ2499/month</option>
                </select>
                <p style="font-size: 13px; color: var(--text-dim); margin-bottom: 10px;">Transfer to:
                    <b>pay-admin@upi</b></p>
                <input type="text" id="payTx" placeholder="Enter UPI Transaction ID">
            </div>
            <button class="btn btn-accent" style="width:100%" onclick="submitPayment()">Submit Payment</button>
            <button class="btn btn-ghost" style="width:100%; margin-top:10px;" onclick="closeModals()">Close</button>
        </div>
    </div>

    <div id="modalBuilder" class="modal" style="display:none; background: #090e1a;">
        <div style="width:100%; height:100%; padding:20px; display:flex; flex-direction:column;">
            <div style="display:flex; justify-content:space-between; margin-bottom:20px;">
                <h2 id="currentFlowTitle">Builder</h2>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-accent" onclick="addNode()">+ Add Block</button>
                    <button class="btn btn-primary" onclick="saveFlow()">Save Flow</button>
                    <button class="btn btn-ghost" onclick="closeBuilder()">Exit</button>
                </div>
            </div>
            <div id="canvas" class="builder-canvas">
                <!-- Nodes logic here -->
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = 'https://uvnksakgjupnivmfkjcv.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV2bmtzYWtnanVwbml2bWZramN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU4NzM5NzYsImV4cCI6MjA4MTQ0OTk3Nn0.gM5hYGxnUI-n_zM-iut8Dml1T5593YhH5A9HNo8hovA';
        const sb = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        let currentUser = null;
        let activeFlowId = null;
        let flowNodes = [];

        window.onload = () => {
            sb.auth.onAuthStateChange((event, session) => {
                if (session) {
                    currentUser = session.user;
                    initApp();
                } else {
                    document.getElementById('authSection').classList.remove('hidden');
                    document.getElementById('appUI').classList.add('hidden');
                }
            });
        };

        async function signIn() {
            await sb.auth.signInWithOAuth({ provider: 'google', options: { redirectTo: window.location.origin } });
        }

        async function signOut() {
            await sb.auth.signOut();
            location.reload();
        }

        async function initApp() {
            document.getElementById('authSection').classList.add('hidden');
            document.getElementById('appUI').classList.remove('hidden');

            // Sync Profile
            const { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
            if (!profile) {
                await sb.from('profiles').insert({ id: currentUser.id, email: currentUser.email, subscription: 'free', is_admin: false });
            }

            loadDashData();
        }

        async function loadDashData() {
            const { data: profile } = await sb.from('profiles').select('*').eq('id', currentUser.id).single();
            document.getElementById('userName').innerText = currentUser.email.split('@')[0];
            document.getElementById('subBadge').innerText = profile.subscription.toUpperCase() + ' PLAN';
            document.getElementById('subBadge').className = `badge badge-${profile.subscription}`;

            if (profile.is_admin) {
                document.getElementById('adminNavItem').classList.remove('hidden');
            }

            const { data: flows } = await sb.from('flows').select('*').eq('user_id', currentUser.id);
            document.getElementById('cntFlows').innerText = flows?.length || 0;

            renderFlowList(flows);
        }

        function switchTab(t) {
            ['dash', 'flows', 'audience', 'admin'].forEach(tab => {
                document.getElementById(`tab-${tab}`)?.classList.add('hidden');
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            });
            document.getElementById(`tab-${t}`).classList.remove('hidden');
            event.currentTarget.classList.add('active');

            if (t === 'admin') loadAdminData();
        }

        function renderFlowList(flows) {
            const html = flows?.map(f => `
                <div class="stat-card" onclick="openBuilderPage('${f.id}', '${f.title}')">
                    <div class="stat-label">FLOW</div>
                    <div style="font-weight:700; font-size:18px;">${f.title}</div>
                    <div style="margin-top:10px; font-size:12px; opacity:0.6;">Click to edit flowchart</div>
                </div>
            `).join('') || '<p>No flows created yet.</p>';
            document.getElementById('flowList').innerHTML = html;
            document.getElementById('flowListDashboard').innerHTML = html;
        }

        // Builder Logic (Simplified for Demo)
        function openBuilderPage(id, title) {
            activeFlowId = id;
            document.getElementById('currentFlowTitle').innerText = title;
            document.getElementById('modalBuilder').style.display = 'block';
            loadFlowContent(id);
        }

        async function loadFlowContent(id) {
            const { data } = await sb.from('flows').select('content').eq('id', id).single();
            const canvas = document.getElementById('canvas');
            canvas.innerHTML = '';
            flowNodes = data?.content || [];
            flowNodes.forEach(node => renderNode(node));
        }

        function addNode() {
            const newNode = {
                id: Date.now(),
                type: 'Message',
                text: 'Hello! How can I help you?',
                x: 50 + (flowNodes.length * 20),
                y: 50 + (flowNodes.length * 20)
            };
            flowNodes.push(newNode);
            renderNode(newNode);
        }

        function renderNode(node) {
            const div = document.createElement('div');
            div.className = 'node';
            div.id = `node-${node.id}`;
            div.style.left = node.x + 'px';
            div.style.top = node.y + 'px';
            div.innerHTML = `
                <div class="node-header">${node.type} Block</div>
                <div class="node-content">
                    <textarea style="background:transparent; border:none; padding:0; font-size:12px; margin:0;" onchange="updateNodeText(${node.id}, this.value)">${node.text}</textarea>
                </div>
                <div style="font-size:10px; margin-top:8px; color:var(--primary); text-align:right;">‚óè Port</div>
            `;
            // Drag logic (Simplified)
            div.onmousedown = (e) => startDrag(e, div, node);
            document.getElementById('canvas').appendChild(div);
        }

        function updateNodeText(id, val) {
            const node = flowNodes.find(n => n.id === id);
            if (node) node.text = val;
        }

        async function saveFlow() {
            await sb.from('flows').update({ content: flowNodes }).eq('id', activeFlowId);
            alert("Flow saved successfully!");
        }

        function startDrag(e, el, node) {
            let offset = { x: e.clientX - el.offsetLeft, y: e.clientY - el.offsetTop };
            document.onmousemove = (me) => {
                let nx = me.clientX - offset.x;
                let ny = me.clientY - offset.y;
                el.style.left = nx + 'px';
                el.style.top = ny + 'px';
                node.x = nx;
                node.y = ny;
            };
            document.onmouseup = () => { document.onmousemove = null; };
        }

        // Admin & Payment Functions
        async function loadAdminData() {
            const { data: users } = await sb.from('profiles').select('*');
            const { data: payments } = await sb.from('payments').select('*, profiles(email)').eq('status', 'pending');

            document.getElementById('adminUsers').innerHTML = `
                <table class="admin-table">
                    <tr><th>User Email</th><th>Plan</th><th>Actions</th></tr>
                    ${users.map(u => `
                        <tr>
                            <td>${u.email}</td>
                            <td><span class="badge badge-${u.subscription}">${u.subscription}</span></td>
                            <td>
                                <button class="btn btn-primary" style="padding:4px 8px; font-size:10px;" onclick="adminChangeSub('${u.id}')">Manage Sub</button>
                                <button class="btn btn-ghost" style="padding:4px 8px; font-size:10px; color:red;" onclick="adminDeleteUser('${u.id}')">Delete</button>
                            </td>
                        </tr>
                    `).join('')}
                </table>`;

            document.getElementById('adminPayments').innerHTML = payments?.map(p => `
                <div class="stat-card" style="margin-bottom:12px; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <b>${p.profiles.email}</b> is requesting <b>${p.plan.toUpperCase()}</b><br>
                        <small style="opacity:0.6;">TX ID: ${p.transaction_id}</small>
                    </div>
                    <button class="btn btn-accent" onclick="approvePay('${p.id}', '${p.user_id}', '${p.plan}')">APPROVE ‚úÖ</button>
                </div>
            `).join('') || '<p style="opacity:0.5;">No pending payments.</p>';
        }

        async function approvePay(id, uid, plan) {
            await sb.from('payments').update({ status: 'approved' }).eq('id', id);
            await sb.from('profiles').update({ subscription: plan }).eq('id', uid);
            alert("Payment Approved! User upgraded.");
            loadAdminData();
        }

        async function adminChangeSub(uid) {
            const newSub = prompt("Enter sub level (free, pro, ultimate, god):", "pro");
            if (newSub) {
                await sb.from('profiles').update({ subscription: newSub }).eq('id', uid);
                loadAdminData();
            }
        }

        async function adminDeleteUser(uid) {
            if (confirm("GOD MODE: Delete this user and ALL their flows?")) {
                await sb.from('profiles').delete().eq('id', uid);
                loadAdminData();
            }
        }

        // UI Helpers
        function closeBuilder() { document.getElementById('modalBuilder').style.display = 'none'; loadDashData(); }
        function openNewFlowModal() { document.getElementById('modalNewFlow').classList.add('active'); }
        function openBilling() { document.getElementById('modalBilling').classList.add('active'); }
        function closeModals() { document.querySelectorAll('.modal').forEach(m => m.classList.remove('active')); }

        async function createNewFlow() {
            const title = document.getElementById('flowTitleInput').value;
            if (!title) return;
            const { data } = await sb.from('flows').insert({ user_id: currentUser.id, title, content: [] }).select().single();
            closeModals();
            openBuilderPage(data.id, data.title);
        }

        async function submitPayment() {
            const plan = document.getElementById('payPlan').value;
            const tx = document.getElementById('payTx').value;
            if (!tx) return alert("Plese enter transaction ID");
            await sb.from('payments').insert({ user_id: currentUser.id, plan, transaction_id: tx, status: 'pending' });
            alert("Payment submitted for admin approval.");
            closeModals();
        }
    </script>
</body>

</html>
